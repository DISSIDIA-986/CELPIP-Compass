# CELPIP Compass 技术设计文档
## High-Level Technical Architecture

**文档版本:** 1.0  
**日期:** 2025年12月29日  
**状态:** Ready for Development  
**目标受众:** Tech Lead, Architects, Development Team  

---

## 📋 文档概览

本文档提供CELPIP Compass Web Application的高层次技术架构设计，包括：
- 系统整体架构
- 核心技术栈选择
- 响应式设计策略
- 关键组件和数据流
- 扩展性和性能考虑

**详细技术实现请见:** Detailed Technical Document

---

## 🏗️ 系统架构概览（Vercel优化版）

```
┌─────────────────────────────────────────────────────────────┐
│               CELPIP Compass (Vercel部署)                  │
└─────────────────────────────────────────────────────────────┘
                            │
                                ▼
                    ┌─────────────────┐
                    │   Next.js App   │
                    │  (Frontend +    │
                    │   API Routes)   │
                    └─────────┬───────┘
                              │
            ┌─────────────────┼─────────────────┐
            │                 │                 │
            ▼                 ▼                 ▼
    ┌───────────────┐ ┌───────────────┐ ┌───────────────┐
    │ API Routes   │ │   Static     │ │   Serverless  │
    │ (Auth/Learning)│ │   Assets    │ │   Functions  │
    │              │ │              │ │ (Analytics)   │
    │ - JWT认证     │ │ - 图片/视频   │ │ - 事件追踪    │
    │ - 学习数据    │ │ - CSS/JS     │ │ - 报告生成    │
    │ - 资源搜索    │ │ - 字体文件   │ │ - 邮件发送    │
    └───────┬───────┘ └───────────────┘ └───────────────┘
            │
            │
    ┌───────▼───────────────────────────────────────┐
    │              数据层                           │
    │                                             │
    │  ┌─────────────────┐   ┌─────────────────┐   │
    │  │   Supabase      │   │   Vercel KV    │   │
    │  │   (PostgreSQL)  │   │   (Redis)       │   │
    │  │                 │   │                │   │
    │  │ - 用户数据       │   │ - 会话存储      │   │
    │  │ - 学习计划       │   │ - 缓存数据      │   │
    │  │ - 进度记录       │   │ - 速率限制      │   │
    │  │ - 社区内容       │   │                │   │
    │  │ - 全文搜索       │   │                │   │
    │  └─────────────────┘   └─────────────────┘   │
    └───────────────────────────────────────────────┘
                              │
        ┌───────────────────┼───────────────────┐
        │                   │                   │
        ▼                   ▼                   ▼
   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐
   │   Supabase  │   │   Vercel    │   │   Cloudflare│
   │   Storage   │   │   Analytics │   │    CDN      │
   │             │   │             │   │             │
   │ - 用户文件   │   │ - 事件追踪   │   │ - 资源加速   │
   │ - 媒体资源   │   │ - 性能监控   │   │ - 图片优化   │
   │ - 备份恢复   │   │ - 错误日志   │   │ - 安全防护   │
   └─────────────┘   └─────────────┘   └─────────────┘
```

---

## 🛠️ 核心技术栈（Vercel优化版）

### 全栈应用 (Next.js 14+)

**前端架构:**
```
Next.js 14+ (全栈方案)
├─ App Router (页面路由)
├─ Server Components (服务端组件)
├─ Client Components (客户端组件)
├─ API Routes (API端点)
├─ Middleware (中间件)
└─ TanStack Query (数据获取)

UI层:
├─ Tailwind CSS (样式框架)
├─ shadcn/ui (组件库)
├─ Framer Motion (动画)
├─ React Hook Form (表单)
└─ Zod (数据验证)
```

**关键特性:**
- ✅ Vercel一键部署
- ✅ Serverless Functions自动扩展
- ✅ 静态生成 + 增量静态再生
- ✅ 自动HTTPS和安全headers
- ✅ 全球CDN加速

**后端功能 (API Routes):**
```
1. 认证模块 (/api/auth)
   ├─ OAuth2 (Google/WeChat)
   ├─ JWT令牌管理
   ├─ 会话验证
   └─ 用户注册/登录

2. 学习模块 (/api/learning)
   ├─ 学习计划CRUD
   ├─ 进度更新
   ├─ CLB评估
   └─ 推荐算法

3. 资源模块 (/api/resources)
   ├─ 资源搜索
   ├─ 分类筛选
   ├─ 收藏管理
   └─ 批量操作

4. 社区模块 (/api/community)
   ├─ 帖子管理
   ├─ 评论系统
   ├─ 点赞功能
   └─ 用户互动

5. 分析模块 (/api/analytics)
   ├─ 事件追踪
   ├─ 数据统计
   └─ 报告生成
```

### 数据层（Vercel友好方案）

**数据库选择:**
```
Supabase (PostgreSQL) - 免费层足够
├─ 用户认证和授权
├─ 关系型数据存储
├─ 实时订阅功能
├─ 全文搜索
├─ 自动备份
└─ 行级安全策略

Vercel KV / Upstash Redis - 免费额度
├─ 会话存储
├─ 缓存热点数据
├─ 速率限制
└── 临时数据存储
```

**为什么选择这个组合:**
- ✅ Supabase免费层500MB数据库 + 2GB带宽/月
- ✅ Vercel KV免费层1GB存储 + 1M请求/月
- ✅ 免费SSL和CDN
- ✅ 自动扩展，无需运维
- ✅ Vercel+Supabase完美集成

### 外部服务集成（免费方案优先）

```
认证 (免费):
├─ Google OAuth2
├─ WeChat OAuth (微信网页登录)
└─ Email/Password (Supabase内置)

媒体 (免费):
├─ YouTube embed (无需API)
├─ Cloudflare CDN (Vercel内置)
└─ Supabase Storage (免费额度1GB)

分析 (免费):
├─ Vercel Analytics (内置)
├─ Supabase Analytics (基础)
└── 自定义事件追踪

文件存储:
├─ Supabase Storage (1GB免费)
├─ Cloudflare R2 (免费层)
└── Vercel Blob (早期用户免费)
```

---

## 📱 响应式设计架构

### Breakpoints 定义

```
Mobile (XS):    0px - 480px   (iPhone SE, 5S, 6)
Mobile (SM):    481px - 768px (iPhone 7/8, iPad Mini)
Tablet (MD):    769px - 1024px (iPad, iPad Air)
Desktop (LG):   1025px - 1440px (MacBook Air, 27" desktop)
Desktop (XL):   1441px+ (MacBook Pro, 4K display)
```

### 响应式布局策略

```
Mobile优先:
1. 从最小屏幕开始设计
2. 逐级添加Media Queries增强体验
3. 优先级: 功能 > 美观

布局系统:
├─ Grid 系统 (12列)
├─ Flex 布局 (主要)
├─ Spacing 响应式
└─ Typography 缩放

导航:
├─ 手机: Hamburger Menu (底部Tab / 侧边抽屉)
├─ 平板: 简化导航 + 侧边栏
└─ 桌面: 完整顶部导航 + 侧边栏

容器:
├─ Mobile: 100% 宽度 - padding
├─ 平板: max-width 90% / 容器宽度
└─ 桌面: max-width 1200px / 居中
```

### 关键页面响应式设计

```
仪表板 (Dashboard):
├─ Mobile: 单列 + 堆叠卡片
├─ 平板: 2列网格 + 卡片
└─ 桌面: 3-4列网格 + 详细面板

学习计划:
├─ Mobile: 任务垂直列表 + 单个展开
├─ 平板: 2列 + 任务预览
└─ 桌面: 3列 + 详细侧面板

资源库:
├─ Mobile: 垂直搜索 + 单列结果
├─ 平板: 侧边过滤 + 2列结果
└─ 桌面: 左侧过滤 + 3列网格
```

---

## 🔄 核心数据流

### 用户注册流程

```
用户 → 选择注册方式 → OAuth/Email
  ↓
验证邮箱 → 生成JWT Token
  ↓
Redirect to CLB自评问卷
  ↓
保存答题结果 → 生成个人学习计划
  ↓
显示Dashboard
```

### 学习流程

```
用户打开应用
  ↓
检查Token → 验证有效性
  ↓
加载Dashboard + 今日任务
  ↓
点击资源 → 加载对应视频/博客
  ↓
标记完成 → 更新Progress记录
  ↓
实时更新仪表板数据
```

### 数据缓存策略

```
浏览器缓存:
├─ Static Assets: 1年
├─ API Responses: 5分钟
└─ User Data: 1分钟

Server缓存 (Redis):
├─ 热门资源: 1小时
├─ 用户会话: 7天
└─ 排行榜数据: 1小时

数据库:
└─ 持久化所有用户数据
```

---

## ⚡ 性能目标

```
Core Web Vitals:
├─ LCP (Largest Contentful Paint): < 2.5秒
├─ FID (First Input Delay): < 100毫秒
├─ CLS (Cumulative Layout Shift): < 0.1

加载时间:
├─ 首屏加载: < 2秒
├─ 页面导航: < 1秒
├─ API响应: < 500毫秒
└─ 资源加载: < 100KB (gzip)

可用性:
└─ 99.9% 正常运行时间

响应性:
└─ 所有交互反应时间 < 200毫秒
```

---

## 🔒 安全架构（Vercel方案）

```
认证层:
├─ Supabase Auth (内置OAuth/JWT)
├─ Next.js Middleware (路由保护)
├─ Secure Cookies (HttpOnly)
└─ CSRF Protection

授权层:
├─ Supabase RLS (行级安全)
├─ 角色基础访问控制
├─ API Routes中间件
└─ Vercel Edge中间件

数据保护:
├─ 自动TLS/SSL (Vercel提供)
├─ PostgreSQL加密字段
├─ 环境变量保护
└─ 敏感数据脱敏

安全监测:
├─ Vercel Analytics (性能监控)
├─ Supabase Audit Logs
├─ 错误追踪 (Sentry免费层)
└─ 安全headers自动注入
```

---

## 📈 扩展性考虑（Vercel弹性扩展）

### 自动扩展（Vercel特性）

```
Serverless自动扩展:
├─ Functions自动扩缩容
├─ 全球边缘网络
├─ 智能缓存策略
└─ 冷启动优化

数据库扩展:
├─ Supabase自动扩展
├─ 读写分离（付费升级）
├─ 连接池管理
└── 按使用量付费

存储扩展:
├─ Supabase Storage按需扩容
├─ Cloudflare R2全球CDN
├─ 图片自动优化
└── 智能压缩
```

### 成本优化策略

**免费层利用:**
- Vercel Hobby: 免费（适合个人项目）
- Supabase: 500MB数据库 + 2GB带宽/月
- Vercel Analytics: 免费性能监控
- Upstash Redis: 1GB存储免费

**升级策略（按需）:**
- Vercel Pro: $20/月（更多函数调用时间）
- Supabase Pro: $25/月（更多数据库资源）
- Cloudflare Pro: $5/月（更好的分析）

---

## 🚀 部署架构（Vercel方案）

```
开发环境:
├─ Vercel本地预览 (vercel dev)
├─ Supabase本地开发
├─ 环境变量管理
└─ 热重载快速迭代

测试环境:
├─ Vercel Preview Deployments
├── 分支预览部署
├─ Supabase Staging环境
└── 自动E2E测试

生产环境:
├─ Vercel Production (一键部署)
├─ Supabase Production DB
├─ 自动HTTPS和CDN
├─ 全球边缘网络
└─ GitHub Actions CI/CD
```

**部署流程:**
```bash
# 1. 代码推送到GitHub
git push origin main

# 2. Vercel自动部署
# - 自动构建和部署
# - 自动生成预览链接
# - 自动运行测试

# 3. 数据库更新
# - Supabase migrations
# - 自动备份
# - 数据同步
```

---

## 📊 监测和日志（Vercel方案）

```
应用监测:
├─ Vercel Analytics (内置)
├─ Core Web Vitals监控
├─ 实时性能数据
└─ 错误追踪和分析

日志系统:
├─ Vercel Logs Functions
├─ Supabase Audit Logs
├─ 结构化日志输出
└── 免费日志存储

用户行为:
├─ Vercel Analytics事件
├─ Supabase Analytics
├─ 自定义事件追踪
└── 热力图分析（可选）
```

**监控仪表板:**
- Vercel Dashboard: 性能、部署、错误监控
- Supabase Dashboard: 数据库使用、用户活动
- 自定义Dashboard: 使用Vercel Analytics构建

---

## 🗺️ 项目里程碑

```
Month 1 (Week 1-2): Foundation
├─ 基础框架搭建
├─ API设计和实现
└─ 响应式UI组件库

Month 1 (Week 3-4): Core Features
├─ 用户认证系统
├─ 学习计划生成器
└─ 资源库集成

Month 2 (Week 1-2): Integration
├─ 完整集成测试
├─ 性能优化
└─ 安全审计

Month 2 (Week 3-4): Launch
├─ 生产部署
├─ 用户反馈收集
└─ 微调和修复
```

---

## 📚 相关文档

| 文档 | 内容 | 受众 |
|------|------|------|
| Detailed Technical Doc | 实现细节/代码结构 | 开发人员 |
| API 规范 | Endpoint/数据模型 | 前后端开发 |
| Database ER图 | 数据库设计 | DBA/后端 |
| 部署文档 | 运维和配置 | DevOps |
| 安全指南 | 安全实现 | 安全团队 |

---

---

## 🔧 Vercel架构优化总结

### 架构简化
- ✅ **优化问题:** 原始微服务架构过于复杂，不适合个人项目
- ✅ **优化方案:**
  - 采用Next.js全栈架构，消除独立后端服务
  - 部署在Vercel，无需服务器管理
  - 使用API Routes处理所有后端逻辑
  - 减少90%的部署复杂度

### 数据库方案优化
- ✅ **优化问题:** 自建PostgreSQL运维复杂度高
- ✅ **优化方案:**
  - 迁移到Supabase（PostgreSQL即服务）
  - 免费层提供500MB数据库空间
  - 自动备份、实时同步、行级安全
  - 无需数据库运维工作

### 成本控制优化
- ✅ **优化问题:** 原架构月成本可能超过$100
- ✅ **优化方案:**
  - Vercel免费版 + Supabase免费层
  - 总成本：$0/月（足够个人项目使用）
  - 按需升级策略，避免过度设计
  - 使用免费CDN和分析服务

### 开发效率优化
- ✅ **优化问题:** 原架构需要配置多个服务
- ✅ **优化方案:**
  - 一键部署：git push到GitHub自动部署
  - 自动HTTPS和CDN配置
  - 预览环境自动生成
  - 热重载开发体验

### 维护简化
- ✅ **优化问题:** 原架构需要维护多个系统
- ✅ **优化方案:**
  - 单一代码库管理
  - 自动扩容的Serverless架构
  - 内置监控和分析工具
  - 无需DevOps专业知识

---

## 📋 待办事项（Vercel优化）

### 第一优先级（MVP）
- [ ] 创建Vercel + Supabase项目
- [ ] 实现基础认证系统
- [ ] 构建CLB自评估问卷
- [ ] 集成学习资源库

### 第二优先级（核心功能）
- [ ] 实现学习路径生成
- [ ] 添加进度追踪功能
- [ ] 构建响应式UI组件
- [ ] 集成YouTube视频资源

### 第三优先级（增强功能）
- [ ] 添加社区功能
- [ ] 实现搜索和推荐
- [ ] 部署到生产环境
- [ ] 添加性能监控

---

**CELPIP Compass High-Level Technical Document**
**版本 1.2 | 2025年12月29日**
**已针对Vercel免费版优化，架构简化成本为零**

