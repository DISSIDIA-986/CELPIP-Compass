# CELPIP Compass æŠ€æœ¯è®¾è®¡æ–‡æ¡£
## Detailed Technical Implementation Guide

**æ–‡æ¡£ç‰ˆæœ¬:** 1.0  
**æ—¥æœŸ:** 2025å¹´12æœˆ29æ—¥  
**çŠ¶æ€:** Ready for Implementation  
**ç›®æ ‡å—ä¼—:** Development Team, DevOps, QA  

---

## ğŸ“‹ æ–‡æ¡£ç»“æ„

1. **é¡¹ç›®åˆå§‹åŒ–å’Œç¯å¢ƒ**
2. **å‰ç«¯æ¶æ„å’Œå®ç°**
3. **åç«¯APIè®¾è®¡**
4. **æ•°æ®åº“è®¾è®¡**
5. **å“åº”å¼è®¾è®¡å®ç°ç»†èŠ‚**
6. **è®¤è¯å’Œæˆæƒ**
7. **é›†æˆå’Œéƒ¨ç½²**
8. **æµ‹è¯•ç­–ç•¥**

---

## 1ï¸âƒ£ é¡¹ç›®åˆå§‹åŒ–å’Œç¯å¢ƒ

### 1.1 é¡¹ç›®ç»“æ„

```
celpip-compass/
â”œâ”€â”€ frontend/                    # React SPA (Next.js)
â”‚   â”œâ”€â”€ public/                 # é™æ€èµ„æº
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ components/         # å¯å¤ç”¨ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ common/        # é€šç”¨ç»„ä»¶ (Header, Footer, Nav)
â”‚   â”‚   â”‚   â”œâ”€â”€ dashboard/     # ä»ªè¡¨æ¿ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ study/         # å­¦ä¹ ç›¸å…³ç»„ä»¶
â”‚   â”‚   â”‚   â””â”€â”€ responsive/    # å“åº”å¼ç‰¹å®šç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ pages/             # é¡µé¢ (Next.js routing)
â”‚   â”‚   â”‚   â”œâ”€â”€ index.tsx      # é¦–é¡µ
â”‚   â”‚   â”‚   â”œâ”€â”€ auth/          # è®¤è¯é¡µé¢
â”‚   â”‚   â”‚   â”œâ”€â”€ dashboard/     # ä»ªè¡¨æ¿
â”‚   â”‚   â”‚   â”œâ”€â”€ learning/      # å­¦ä¹ è·¯å¾„
â”‚   â”‚   â”‚   â””â”€â”€ resources/     # èµ„æºåº“
â”‚   â”‚   â”œâ”€â”€ styles/            # å…¨å±€æ ·å¼ + Tailwind
â”‚   â”‚   â”‚   â”œâ”€â”€ globals.css
â”‚   â”‚   â”‚   â”œâ”€â”€ responsive.css # å“åº”å¼è§„åˆ™
â”‚   â”‚   â”‚   â””â”€â”€ components.css
â”‚   â”‚   â”œâ”€â”€ hooks/             # è‡ªå®šä¹‰Hooks
â”‚   â”‚   â”œâ”€â”€ store/             # ZustandçŠ¶æ€ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ services/          # APIè°ƒç”¨æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ utils/             # å·¥å…·å‡½æ•°
â”‚   â”‚   â”œâ”€â”€ types/             # TypeScriptç±»å‹
â”‚   â”‚   â””â”€â”€ constants/         # å¸¸é‡å®šä¹‰
â”‚   â”œâ”€â”€ public/               # SEOä¼˜åŒ–
â”‚   â””â”€â”€ next.config.js        # Next.jsé…ç½®
â”‚
â”œâ”€â”€ backend/                   # Node.js/Express API
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ routes/           # APIè·¯ç”±
â”‚   â”‚   â”‚   â”œâ”€â”€ auth.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ users.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ learning.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ resources.ts
â”‚   â”‚   â”‚   â””â”€â”€ admin.ts
â”‚   â”‚   â”œâ”€â”€ controllers/      # ä¸šåŠ¡é€»è¾‘
â”‚   â”‚   â”œâ”€â”€ services/         # æœåŠ¡å±‚
â”‚   â”‚   â”œâ”€â”€ middleware/       # ä¸­é—´ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ auth.ts       # JWTéªŒè¯
â”‚   â”‚   â”‚   â”œâ”€â”€ validation.ts # æ•°æ®éªŒè¯
â”‚   â”‚   â”‚   â””â”€â”€ errorHandler.ts
â”‚   â”‚   â”œâ”€â”€ models/           # æ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ utils/            # å·¥å…·å‡½æ•°
â”‚   â”‚   â”œâ”€â”€ config/           # é…ç½®æ–‡ä»¶
â”‚   â”‚   â””â”€â”€ app.ts            # ä¸»åº”ç”¨æ–‡ä»¶
â”‚   â”œâ”€â”€ migrations/           # æ•°æ®åº“è¿ç§»
â”‚   â”œâ”€â”€ tests/                # æµ‹è¯•ç”¨ä¾‹
â”‚   â””â”€â”€ docker-compose.yml    # æœ¬åœ°å¼€å‘ç¯å¢ƒ
â”‚
â”œâ”€â”€ database/                  # æ•°æ®åº“è®¾è®¡
â”‚   â”œâ”€â”€ schema/               # SQL Schema
â”‚   â”œâ”€â”€ migrations/           # ç‰ˆæœ¬ç®¡ç†
â”‚   â””â”€â”€ seeds/                # åˆå§‹æ•°æ®
â”‚
â”œâ”€â”€ docs/                      # æ–‡æ¡£
â”‚   â”œâ”€â”€ API.md                # APIè§„èŒƒ
â”‚   â”œâ”€â”€ DATABASE.md           # æ•°æ®åº“è®¾è®¡
â”‚   â”œâ”€â”€ DEPLOYMENT.md         # éƒ¨ç½²æŒ‡å—
â”‚   â””â”€â”€ CONTRIBUTING.md       # è´¡çŒ®æŒ‡å—
â”‚
â””â”€â”€ .github/
    â””â”€â”€ workflows/            # CI/CD Pipeline
        â”œâ”€â”€ build.yml
        â”œâ”€â”€ test.yml
        â””â”€â”€ deploy.yml
```

### 1.2 ç¯å¢ƒå˜é‡ (.env.example)

```bash
# å‰ç«¯ç¯å¢ƒå˜é‡
NEXT_PUBLIC_API_URL=http://localhost:3001
NEXT_PUBLIC_GOOGLE_CLIENT_ID=your_google_client_id
NEXT_PUBLIC_WECHAT_APP_ID=your_wechat_app_id
NEXT_PUBLIC_ANALYTICS_ID=your_analytics_id

# åç«¯ç¯å¢ƒå˜é‡
PORT=3001
NODE_ENV=development

# æ•°æ®åº“
DATABASE_URL=postgresql://user:password@localhost:5432/celpip_dev
REDIS_URL=redis://localhost:6379

# è®¤è¯
JWT_SECRET=your_jwt_secret_key_min_32_chars
JWT_EXPIRY=15m
REFRESH_TOKEN_EXPIRY=7d

# OAuth
GOOGLE_CLIENT_SECRET=your_google_secret
WECHAT_SECRET=your_wechat_secret

# å­˜å‚¨
AWS_S3_BUCKET=celpip-compass-prod
AWS_S3_REGION=us-east-1
AWS_ACCESS_KEY_ID=your_access_key
AWS_SECRET_ACCESS_KEY=your_secret_key

# å¤–éƒ¨æœåŠ¡
YOUTUBE_API_KEY=your_youtube_api_key
SENDGRID_API_KEY=your_sendgrid_key
STRIPE_SECRET_KEY=your_stripe_secret

# ç›‘æµ‹
SENTRY_DSN=your_sentry_dsn
```

### 1.3 Docker Compose (æœ¬åœ°å¼€å‘)

```yaml
version: '3.8'

services:
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: celpip_dev
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  backend:
    build: ./backend
    ports:
      - "3001:3001"
    environment:
      - DATABASE_URL=postgresql://user:password@postgres:5432/celpip_dev
      - REDIS_URL=redis://redis:6379
    depends_on:
      - postgres
      - redis
    volumes:
      - ./backend:/app
    command: npm run dev

  frontend:
    build: ./frontend
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:3001
    depends_on:
      - backend
    volumes:
      - ./frontend:/app
    command: npm run dev

volumes:
  postgres_data:
  redis_data:
```

---

## 2ï¸âƒ£ å‰ç«¯æ¶æ„å’Œå®ç°

### 2.1 ä½¿ç”¨Next.js 14çš„åŸå› 

```
vs Create React App:
âœ… å†…ç½®SSR / SSG (æ€§èƒ½æ›´å¥½)
âœ… å†…ç½®è·¯ç”±ç³»ç»Ÿ (ä¸éœ€è¦React Router)
âœ… API Routes (å¯é€‰åç«¯)
âœ… å›¾ç‰‡ä¼˜åŒ–å’Œè‡ªåŠ¨WebP
âœ… è‡ªåŠ¨ä»£ç åˆ†å‰²
âœ… æ›´å¥½çš„SEOæ”¯æŒ
âœ… å¼€å‘ä½“éªŒæ›´å¥½ (Fast Refresh)

é€‰æ‹©Next.jsè€Œä¸æ˜¯Vite:
âœ… ä¼ä¸šçº§æ”¯æŒ
âœ… æ›´å¥½çš„SEO
âœ… å†…ç½®åˆ†æå·¥å…·
âœ… ä¸Vercelæ·±åº¦é›†æˆ (éƒ¨ç½²ä¾¿æ·)
```

### 2.2 Next.js 14 é¡¹ç›®åˆå§‹åŒ–ï¼ˆæ¨èä½¿ç”¨ App Routerï¼‰

```bash
# åˆ›å»º Next.js 14 é¡¹ç›®ï¼ˆä½¿ç”¨ App Routerï¼‰
npx create-next-app@latest celpip-compass-frontend \
  --typescript \
  --tailwind \
  --eslint \
  --app \
  --src-dir \
  --import-alias "@/*"

# å®‰è£…æ ¸å¿ƒä¾èµ–
cd frontend
npm install zustand axios @tanstack/react-query next-themes lucide-react framer-motion
npm install -D @types/node @types/react @types/react-dom

# éªŒè¯é¡¹ç›®ç»“æ„
ls -la
# åº”è¯¥çœ‹åˆ°ï¼š
# src/
#   app/          # App Router é¡µé¢
#   components/   # React ç»„ä»¶
#   lib/          # å·¥å…·å‡½æ•°å’Œé…ç½®
#   styles/       # å…¨å±€æ ·å¼
```

### 2.3 é¡¹ç›®ç»“æ„ä¼˜åŒ–ï¼ˆç¬¦åˆ Next.js æœ€ä½³å®è·µï¼‰

```
frontend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app/                    # Next.js App Router
â”‚   â”‚   â”œâ”€â”€ globals.css         # å…¨å±€æ ·å¼
â”‚   â”‚   â”œâ”€â”€ layout.tsx          # æ ¹å¸ƒå±€
â”‚   â”‚   â”œâ”€â”€ page.tsx            # é¦–é¡µ
â”‚   â”‚   â”œâ”€â”€ (auth)/             # è®¤è¯é¡µé¢ç»„
â”‚   â”‚   â”‚   â”œâ”€â”€ login/page.tsx
â”‚   â”‚   â”‚   â””â”€â”€ register/page.tsx
â”‚   â”‚   â”œâ”€â”€ dashboard/         # ä»ªè¡¨æ¿
â”‚   â”‚   â”‚   â”œâ”€â”€ layout.tsx      # ä»ªè¡¨æ¿å¸ƒå±€
â”‚   â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”‚   â”œâ”€â”€ learning/           # å­¦ä¹ æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ resources/          # èµ„æºåº“
â”‚   â”‚   â””â”€â”€ api/                # API Routesï¼ˆå¯é€‰ï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ components/             # ç»„ä»¶åº“
â”‚   â”‚   â”œâ”€â”€ ui/                 # åŸºç¡€ UI ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ button.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ card.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ input.tsx
â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â”œâ”€â”€ forms/              # è¡¨å•ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ layout/             # å¸ƒå±€ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ header.tsx
â”‚   â”‚   â”‚   â”œâ”€â”€ sidebar.tsx
â”‚   â”‚   â”‚   â””â”€â”€ navigation.tsx
â”‚   â”‚   â”œâ”€â”€ features/           # åŠŸèƒ½ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”‚   â”œâ”€â”€ dashboard/
â”‚   â”‚   â”‚   â””â”€â”€ learning/
â”‚   â”‚   â””â”€â”€ responsive/         # å“åº”å¼ç»„ä»¶
â”‚   â”‚
â”‚   â”œâ”€â”€ lib/                    # å·¥å…·å’Œé…ç½®
â”‚   â”‚   â”œâ”€â”€ utils.ts            # å·¥å…·å‡½æ•°
â”‚   â”‚   â”œâ”€â”€ api.ts              # API å®¢æˆ·ç«¯
â”‚   â”‚   â”œâ”€â”€ auth.ts             # è®¤è¯ç›¸å…³
â”‚   â”‚   â”œâ”€â”€ constants.ts        # å¸¸é‡å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ hooks.ts            # è‡ªå®šä¹‰ Hooks
â”‚   â”‚   â””â”€â”€ validators.ts       # æ•°æ®éªŒè¯
â”‚   â”‚
â”‚   â”œâ”€â”€ types/                  # TypeScript ç±»å‹å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ api.ts              # API ç›¸å…³ç±»å‹
â”‚   â”‚   â”œâ”€â”€ auth.ts             # è®¤è¯ç±»å‹
â”‚   â”‚   â”œâ”€â”€ resources.ts        # èµ„æºç±»å‹
â”‚   â”‚   â””â”€â”€ index.ts            # ç»Ÿä¸€å¯¼å‡º
â”‚   â”‚
â”‚   â”œâ”€â”€ store/                  # çŠ¶æ€ç®¡ç†ï¼ˆZustandï¼‰
â”‚   â”‚   â”œâ”€â”€ auth-store.ts
â”‚   â”‚   â”œâ”€â”€ learning-store.ts
â”‚   â”‚   â”œâ”€â”€ resource-store.ts
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ hooks/                  # è‡ªå®šä¹‰ Hooks
â”‚   â”‚   â”œâ”€â”€ use-auth.ts
â”‚   â”‚   â”œâ”€â”€ use-resources.ts
â”‚   â”‚   â””â”€â”€ use-progress.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ styles/                 # æ ·å¼æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ globals.css
â”‚   â”‚   â”œâ”€â”€ tailwind.css
â”‚   â”‚   â””â”€â”€ components.css
â”‚   â”‚
â”‚   â””â”€â”€ public/                 # é™æ€èµ„æº
â”‚       â”œâ”€â”€ images/
â”‚       â”œâ”€â”€ icons/
â”‚       â””â”€â”€ favicon.ico
```

### 2.4 Next.js App Router å®ç°ç¤ºä¾‹

```typescript
// src/app/layout.tsx - æ ¹å¸ƒå±€
import { Inter } from 'next/font/google';
import { Providers } from '@/components/providers';
import { Header } from '@/components/layout/header';
import { Toaster } from '@/components/ui/toaster';

const inter = Inter({ subsets: ['latin'] });

export const metadata = {
  title: 'CELPIP Compass',
  description: 'Professional CELPIP test preparation platform',
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="en" suppressHydrationWarning>
      <body className={inter.className}>
        <Providers>
          <div className="min-h-screen bg-background font-sans antialiased">
            <Header />
            <main className="flex-1">
              {children}
            </main>
            <Toaster />
          </div>
        </Providers>
      </body>
    </html>
  );
}

// src/app/dashboard/layout.tsx - ä»ªè¡¨æ¿å¸ƒå±€
import { DashboardSidebar } from '@/components/layout/sidebar';
import { DashboardHeader } from '@/components/layout/dashboard-header';

export default function DashboardLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <div className="min-h-screen bg-gray-50">
      <DashboardHeader />
      <div className="flex">
        <DashboardSidebar />
        <main className="flex-1 p-6 ml-64">
          {children}
        </main>
      </div>
    </div>
  );
}

// src/components/providers.tsx - å…¨å±€ Providers
'use client';

import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import { ReactQueryDevtools } from '@tanstack/react-query-devtools';
import { ThemeProvider as NextThemesProvider } from 'next-themes';
import { useState } from 'react';

export function Providers({ children }: { children: React.ReactNode }) {
  const [queryClient] = useState(
    () =>
      new QueryClient({
        defaultOptions: {
          queries: {
            staleTime: 60 * 1000, // 1 minute
            refetchOnWindowFocus: false,
          },
        },
      })
  );

  return (
    <NextThemesProvider
      attribute="class"
      defaultTheme="system"
      enableSystem
      disableTransitionOnChange
    >
      <QueryClientProvider client={queryClient}>
        {children}
        <ReactQueryDevtools initialIsOpen={false} />
      </QueryClientProvider>
    </NextThemesProvider>
  );
}
```

### 2.3 å“åº”å¼è®¾è®¡å®ç°

#### Tailwind CSSé…ç½® (tailwind.config.js)

```javascript
/** @type {import('tailwindcss').Config} */
module.exports = {
  content: [
    './src/pages/**/*.{js,ts,jsx,tsx,mdx}',
    './src/components/**/*.{js,ts,jsx,tsx,mdx}',
    './src/app/**/*.{js,ts,jsx,tsx,mdx}',
  ],
  theme: {
    extend: {
      screens: {
        'xs': '0px',      // æ‰‹æœºå°
        'sm': '481px',    // æ‰‹æœºå¤§
        'md': '769px',    // å¹³æ¿
        'lg': '1025px',   // æ¡Œé¢
        'xl': '1441px',   // æ¡Œé¢å¤§
      },
      colors: {
        primary: 'var(--color-primary)',
        secondary: 'var(--color-secondary)',
        background: 'var(--color-background)',
      },
      spacing: {
        'safe-bottom': 'env(safe-area-inset-bottom)',
      },
    },
  },
  plugins: [],
}
```

#### å“åº”å¼Gridç³»ç»Ÿ

```typescript
// components/responsive/ResponsiveGrid.tsx
interface ResponsiveGridProps {
  children: React.ReactNode;
  cols?: {
    xs: number;
    sm?: number;
    md?: number;
    lg?: number;
    xl?: number;
  };
  gap?: string;
}

export const ResponsiveGrid: React.FC<ResponsiveGridProps> = ({
  children,
  cols = { xs: 1, sm: 1, md: 2, lg: 3, xl: 4 },
  gap = '4',
}) => {
  return (
    <div
      className={`
        grid
        grid-cols-${cols.xs}
        sm:grid-cols-${cols.sm || cols.xs}
        md:grid-cols-${cols.md || 2}
        lg:grid-cols-${cols.lg || 3}
        xl:grid-cols-${cols.xl || 4}
        gap-${gap}
      `}
    >
      {children}
    </div>
  );
};
```

#### å“åº”å¼å¯¼èˆªç»„ä»¶ï¼ˆç¬¦åˆ Next.js æœ€ä½³å®è·µï¼‰

```typescript
// src/components/layout/navigation.tsx - ä½¿ç”¨ Next.js Link ç»„ä»¶
'use client';

import { useState } from 'react';
import Link from 'next/link';
import { usePathname } from 'next/navigation';
import { cn } from '@/lib/utils';
import { Button } from '@/components/ui/button';
import { Menu, X, BookOpen, Target, Users, Home } from 'lucide-react';

const navigation = [
  { name: 'Home', href: '/', icon: Home },
  { name: 'Dashboard', href: '/dashboard', icon: Target },
  { name: 'Learning', href: '/learning', icon: BookOpen },
  { name: 'Resources', href: '/resources', icon: Users },
];

export function Navigation() {
  const [isMenuOpen, setIsMenuOpen] = useState(false);
  const pathname = usePathname();

  return (
    <>
      {/* Desktop Navigation */}
      <nav className="hidden md:flex bg-white shadow-sm border-b">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between h-16">
            <div className="flex">
              <div className="flex-shrink-0 flex items-center">
                <Link href="/" className="text-xl font-bold text-blue-600">
                  CELPIP Compass
                </Link>
              </div>
              <div className="hidden sm:ml-6 sm:flex sm:space-x-8">
                {navigation.map((item) => {
                  const Icon = item.icon;
                  return (
                    <Link
                      key={item.name}
                      href={item.href}
                      className={cn(
                        'inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium',
                        pathname === item.href
                          ? 'border-blue-500 text-gray-900'
                          : 'border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700'
                      )}
                    >
                      <Icon className="h-4 w-4 mr-2" />
                      {item.name}
                    </Link>
                  );
                })}
              </div>
            </div>
            <div className="flex items-center space-x-4">
              <Button variant="outline" size="sm">
                Sign In
              </Button>
              <Button size="sm">
                Get Started
              </Button>
            </div>
          </div>
        </div>
      </nav>

      {/* Mobile Navigation */}
      <nav className="md:hidden bg-white shadow-sm">
        <div className="px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between h-16">
            <div className="flex">
              <div className="flex-shrink-0 flex items-center">
                <Link href="/" className="text-lg font-bold text-blue-600">
                  Compass
                </Link>
              </div>
            </div>
            <div className="flex items-center">
              <Button
                variant="ghost"
                size="sm"
                onClick={() => setIsMenuOpen(!isMenuOpen)}
              >
                {isMenuOpen ? (
                  <X className="h-6 w-6" />
                ) : (
                  <Menu className="h-6 w-6" />
                )}
              </Button>
            </div>
          </div>
        </div>

        {/* Mobile Menu */}
        {isMenuOpen && (
          <div className="md:hidden">
            <div className="pt-2 pb-3 space-y-1">
              {navigation.map((item) => {
                const Icon = item.icon;
                return (
                  <Link
                    key={item.name}
                    href={item.href}
                    className={cn(
                      'flex items-center pl-3 pr-4 py-2 border-l-4 text-base font-medium',
                      pathname === item.href
                        ? 'bg-blue-50 border-blue-500 text-blue-700'
                        : 'border-transparent text-gray-600 hover:bg-gray-50 hover:border-gray-300 hover:text-gray-800'
                    )}
                    onClick={() => setIsMenuOpen(false)}
                  >
                    <Icon className="h-5 w-5 mr-3" />
                    {item.name}
                  </Link>
                );
              })}
            </div>
            <div className="pt-4 pb-3 border-t border-gray-200">
              <div className="flex items-center px-4">
                <div className="flex-shrink-0">
                  <div className="h-10 w-10 rounded-full bg-gray-300 flex items-center justify-center">
                    <span className="text-sm font-medium text-gray-700">U</span>
                  </div>
                </div>
                <div className="ml-3">
                  <div className="text-base font-medium text-gray-800">User</div>
                  <div className="text-sm font-medium text-gray-500">user@example.com</div>
                </div>
              </div>
              <div className="mt-3 space-y-1">
                <Link
                  href="/profile"
                  className="block px-4 py-2 text-base font-medium text-gray-500 hover:text-gray-800 hover:bg-gray-100"
                >
                  Your Profile
                </Link>
                <Link
                  href="/settings"
                  className="block px-4 py-2 text-base font-medium text-gray-500 hover:text-gray-800 hover:bg-gray-100"
                >
                  Settings
                </Link>
                <button
                  onClick={() => setIsMenuOpen(false)}
                  className="block w-full text-left px-4 py-2 text-base font-medium text-gray-500 hover:text-gray-800 hover:bg-gray-100"
                >
                  Sign out
                </button>
              </div>
            </div>
          </div>
        )}
      </nav>
    </>
  );
}
```

#### å“åº”å¼å¡ç‰‡ç»„ä»¶

```typescript
// components/Card.tsx
interface CardProps {
  title?: string;
  children: React.ReactNode;
  className?: string;
  onAction?: () => void;
  actionLabel?: string;
}

export const Card: React.FC<CardProps> = ({
  title,
  children,
  className = '',
  onAction,
  actionLabel,
}) => {
  return (
    <div className={`
      bg-white rounded-lg shadow
      p-4 sm:p-6 md:p-8
      w-full
      hover:shadow-lg transition-shadow
      ${className}
    `}>
      {title && (
        <h3 className="text-lg sm:text-xl font-bold mb-3 sm:mb-4">
          {title}
        </h3>
      )}
      
      <div className="text-sm sm:text-base">
        {children}
      </div>

      {onAction && (
        <button
          onClick={onAction}
          className="mt-4 w-full sm:w-auto bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 text-sm sm:text-base"
        >
          {actionLabel || 'Action'}
        </button>
      )}
    </div>
  );
};
```

### 2.4 çŠ¶æ€ç®¡ç† (Zustand)

```typescript
// store/useAppStore.ts
import create from 'zustand';
import { persist } from 'zustand/middleware';

interface User {
  id: string;
  email: string;
  name: string;
  clbLevel: number;
}

interface AppStore {
  user: User | null;
  isAuthenticated: boolean;
  token: string | null;
  
  // Actions
  login: (user: User, token: string) => void;
  logout: () => void;
  setUser: (user: User) => void;
  updateProgress: (progress: any) => void;
}

export const useAppStore = create<AppStore>()(
  persist(
    (set) => ({
      user: null,
      isAuthenticated: false,
      token: null,

      login: (user, token) =>
        set({
          user,
          token,
          isAuthenticated: true,
        }),

      logout: () =>
        set({
          user: null,
          token: null,
          isAuthenticated: false,
        }),

      setUser: (user) => set({ user }),

      updateProgress: (progress) =>
        set((state) => ({
          user: state.user
            ? { ...state.user, progress }
            : null,
        })),
    }),
    {
      name: 'app-store',
      partialize: (state) => ({
        user: state.user,
        token: state.token,
      }),
    }
  )
);
```

### 2.5 APIæœåŠ¡å±‚

```typescript
// services/api.ts
import axios, { AxiosInstance } from 'axios';
import { useAppStore } from '../store/useAppStore';

class ApiService {
  private client: AxiosInstance;

  constructor() {
    this.client = axios.create({
      baseURL: process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3001',
      timeout: 10000,
    });

    // Requestæ‹¦æˆªå™¨ï¼šæ·»åŠ Token
    this.client.interceptors.request.use((config) => {
      const token = useAppStore.getState().token;
      if (token) {
        config.headers.Authorization = `Bearer ${token}`;
      }
      return config;
    });

    // Responseæ‹¦æˆªå™¨ï¼šå¤„ç†401
    this.client.interceptors.response.use(
      (response) => response,
      (error) => {
        if (error.response?.status === 401) {
          useAppStore.getState().logout();
          window.location.href = '/auth/login';
        }
        return Promise.reject(error);
      }
    );
  }

  // Auth API
  async login(email: string, password: string) {
    const { data } = await this.client.post('/api/auth/login', {
      email,
      password,
    });
    return data;
  }

  async signUp(email: string, password: string, name: string) {
    const { data } = await this.client.post('/api/auth/signup', {
      email,
      password,
      name,
    });
    return data;
  }

  // Learning Plans API
  async getLearningPlan(userId: string) {
    const { data } = await this.client.get(`/api/learning-plans/${userId}`);
    return data;
  }

  async generateLearningPlan(clbLevel: number) {
    const { data } = await this.client.post('/api/learning-plans/generate', {
      clbLevel,
    });
    return data;
  }

  // Progress API
  async updateProgress(resourceId: string, status: 'completed' | 'in_progress') {
    const { data } = await this.client.post('/api/progress', {
      resourceId,
      status,
    });
    return data;
  }

  async getProgress(userId: string) {
    const { data } = await this.client.get(`/api/progress/${userId}`);
    return data;
  }
}

export const apiService = new ApiService();
```

---

## 3ï¸âƒ£ åç«¯APIè®¾è®¡

### 3.1 API Endpoint è§„èŒƒ

```
åŸºç¡€URL: https://api.celpip-compass.com/api/v1

è®¤è¯:
POST   /auth/register           # æ³¨å†Œ
POST   /auth/login              # ç™»å½•
POST   /auth/refresh            # åˆ·æ–°Token
POST   /auth/logout             # ç™»å‡º
POST   /auth/google/callback    # Google OAuth
POST   /auth/wechat/callback    # WeChat OAuth

ç”¨æˆ·:
GET    /users/profile           # è·å–ä¸ªäººèµ„æ–™
PUT    /users/profile           # æ›´æ–°ä¸ªäººèµ„æ–™
GET    /users/settings          # è·å–è®¾ç½®
PUT    /users/settings          # æ›´æ–°è®¾ç½®

å­¦ä¹ è®¡åˆ’:
GET    /learning-plans          # è·å–å½“å‰è®¡åˆ’
POST   /learning-plans/generate # ç”Ÿæˆæ–°è®¡åˆ’
PUT    /learning-plans/:id      # æ›´æ–°è®¡åˆ’
GET    /learning-plans/:id/tasks # è·å–å‘¨ä»»åŠ¡

èµ„æºåº“:
GET    /resources               # åˆ—è¡¨ (åˆ†é¡µ/ç­›é€‰)
GET    /resources/:id           # è¯¦æƒ…
GET    /resources/search        # æœç´¢
GET    /resources/featured      # çƒ­é—¨èµ„æº

è¿›åº¦è¿½è¸ª:
POST   /progress                # è®°å½•å®Œæˆ
GET    /progress                # è·å–è¿›åº¦
GET    /progress/dashboard      # ä»ªè¡¨æ¿æ•°æ®

ç¤¾åŒº:
GET    /community/stories       # æˆåŠŸæ•…äº‹åˆ—è¡¨
POST   /community/stories       # å‘å¸ƒæ•…äº‹
GET    /community/qa            # Q&Aåˆ—è¡¨
POST   /community/qa            # æé—®
```

### 3.2 ExpressæœåŠ¡å™¨åˆå§‹åŒ–ï¼ˆå¢å¼ºé”™è¯¯å¤„ç†ï¼‰

```typescript
// backend/src/app.ts
import express from 'express';
import cors from 'cors';
import helmet from 'helmet';
import rateLimit from 'express-rate-limit';
import { errorHandler } from './middleware/errorHandler';
import { notFoundHandler } from './middleware/notFoundHandler';
import authRoutes from './routes/auth';
import userRoutes from './routes/users';
import learningRoutes from './routes/learning';
import { setupSecurityHeaders } from './middleware/securityHeaders';

const app = express();

// å®‰å…¨ä¸­é—´ä»¶
app.use(helmet());
app.use(cors({
  origin: process.env.FRONTEND_URL || 'http://localhost:3000',
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH'],
  allowedHeaders: ['Content-Type', 'Authorization', 'X-Requested-With'],
}));

// å®‰å…¨å¤´ä¸­é—´ä»¶
app.use(setupSecurityHeaders());

// è¯·æ±‚IDç”Ÿæˆ
app.use((req, res, next) => {
  req.id = `req_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
  next();
});

// é€Ÿç‡é™åˆ¶
const apiLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15åˆ†é’Ÿ
  max: 100, // 100ä¸ªè¯·æ±‚
  standardHeaders: true,
  legacyHeaders: false,
  message: {
    error: 'Too many requests from this IP',
    code: 'RATE_LIMIT_EXCEEDED',
    retryAfter: 900
  }
});
app.use('/api/', apiLimiter);

// ä¸¥æ ¼è§£æä¸­é—´ä»¶
app.use(express.json({ limit: '10mb', strict: true }));
app.use(express.urlencoded({ limit: '10mb', extended: true }));

// è¯·æ±‚æ—¥å¿—ä¸­é—´ä»¶
app.use((req, res, next) => {
  const start = Date.now();

  res.on('finish', () => {
    const duration = Date.now() - start;
    console.log(`${req.method} ${req.path} - ${res.statusCode} - ${duration}ms`);
  });

  next();
});

// APIè·¯ç”±
app.use('/api/auth', authRoutes);
app.use('/api/users', userRoutes);
app.use('/api/learning', learningRoutes);

// å¥åº·æ£€æŸ¥ç«¯ç‚¹
app.get('/health', (req, res) => {
  res.status(200).json({
    status: 'ok',
    timestamp: new Date().toISOString(),
    uptime: process.uptime(),
    environment: process.env.NODE_ENV
  });
});

// 404å¤„ç†
app.use(notFoundHandler);

// å…¨å±€é”™è¯¯å¤„ç†
app.use(errorHandler);

// æœªæ•è·çš„å¼‚å¸¸å¤„ç†
process.on('uncaughtException', (error) => {
  console.error('Uncaught Exception:', error);
  process.exit(1);
});

process.on('unhandledRejection', (reason, promise) => {
  console.error('Unhandled Rejection at:', promise, 'reason:', reason);
});

export default app;
```

### 3.3 å¢å¼ºé”™è¯¯å¤„ç†ä¸­é—´ä»¶

```typescript
// backend/src/middleware/errorHandler.ts
import { Request, Response, NextFunction } from 'express';

// è‡ªå®šä¹‰é”™è¯¯ç±»
export class AppError extends Error {
  public statusCode: number;
  public code: string;
  public isOperational: boolean;
  public details?: any;

  constructor(
    statusCode: number,
    message: string,
    code: string,
    isOperational = true,
    details?: any
  ) {
    super(message);
    this.statusCode = statusCode;
    this.code = code;
    this.isOperational = isOperational;
    this.details = details;

    Error.captureStackTrace(this, this.constructor);
  }
}

// é”™è¯¯ç±»å‹å®šä¹‰
export type ErrorType =
  | 'VALIDATION_ERROR'
  | 'AUTHENTICATION_ERROR'
  | 'AUTHORIZATION_ERROR'
  | 'NOT_FOUND'
  | 'DATABASE_ERROR'
  | 'EXTERNAL_API_ERROR'
  | 'RATE_LIMIT_EXCEEDED'
  | 'INTERNAL_ERROR';

// é”™è¯¯æ˜ å°„
const errorMap: Record<ErrorType, { statusCode: number; message: string }> = {
  VALIDATION_ERROR: { statusCode: 400, message: 'Validation failed' },
  AUTHENTICATION_ERROR: { statusCode: 401, message: 'Authentication failed' },
  AUTHORIZATION_ERROR: { statusCode: 403, message: 'Access denied' },
  NOT_FOUND: { statusCode: 404, message: 'Resource not found' },
  DATABASE_ERROR: { statusCode: 500, message: 'Database operation failed' },
  EXTERNAL_API_ERROR: { statusCode: 502, message: 'External API error' },
  RATE_LIMIT_EXCEEDED: { statusCode: 429, message: 'Rate limit exceeded' },
  INTERNAL_ERROR: { statusCode: 500, message: 'Internal server error' }
};

// é”™è¯¯å“åº”æ ¼å¼
interface ErrorResponse {
  success: false;
  error: {
    code: string;
    message: string;
    details?: any;
  };
  timestamp: string;
  requestId: string;
  path: string;
}

// åˆ›å»ºé”™è¯¯å“åº”
const createErrorResponse = (error: AppError, req: Request): ErrorResponse => ({
  success: false,
  error: {
    code: error.code,
    message: error.message,
    details: process.env.NODE_ENV === 'development' ? error.details : undefined
  },
  timestamp: new Date().toISOString(),
  requestId: req.id || 'unknown',
  path: req.path
});

// é”™è¯¯å¤„ç†ä¸­é—´ä»¶
export const errorHandler = (
  error: AppError,
  req: Request,
  res: Response,
  next: NextFunction
) => {
  const statusCode = error.statusCode || 500;
  const errorResponse = createErrorResponse(error, req);

  // è®°å½•é”™è¯¯
  console.error(`[${req.id}] Error:`, {
    error: error.message,
    code: error.code,
    statusCode,
    path: req.path,
    method: req.method,
    userAgent: req.get('User-Agent'),
    ip: req.ip,
    timestamp: new Date().toISOString()
  });

  // æ ¹æ®ç¯å¢ƒè¿”å›ä¸åŒçš„å“åº”
  if (process.env.NODE_ENV === 'production') {
    // ç”Ÿäº§ç¯å¢ƒéšè—æ•æ„Ÿä¿¡æ¯
    const { details, ...safeError } = errorResponse.error;
    return res.status(statusCode).json({
      ...errorResponse,
      error: safeError
    });
  }

  // å¼€å‘ç¯å¢ƒè¿”å›å®Œæ•´é”™è¯¯ä¿¡æ¯
  res.status(statusCode).json(errorResponse);
};

// åŒæ­¥é”™è¯¯å¤„ç†åŒ…è£…å™¨
export const catchAsync = (fn: Function) => {
  return (req: Request, res: Response, next: NextFunction) => {
    fn(req, res, next).catch((error: AppError) => {
      next(error);
    });
  };
};

// éªŒè¯é”™è¯¯å¤„ç†
export const handleValidationError = (details: any): AppError => {
  return new AppError(
    400,
    'Validation failed',
    'VALIDATION_ERROR',
    true,
    details
  );
};

// æ•°æ®åº“é”™è¯¯å¤„ç†
export const handleDatabaseError = (error: any): AppError => {
  console.error('Database Error:', error);

  if (error.code === '23505') {
    return new AppError(
      409,
      'Resource already exists',
      'DUPLICATE_RESOURCE',
      true
    );
  }

  return new AppError(
    500,
    'Database operation failed',
    'DATABASE_ERROR',
    true,
    process.env.NODE_ENV === 'development' ? error : undefined
  );
};

// è®¤è¯é”™è¯¯å¤„ç†
export const handleAuthError = (message: string = 'Authentication failed'): AppError => {
  return new AppError(
    401,
    message,
    'AUTHENTICATION_ERROR',
    true
  );
};

// 404å¤„ç†å™¨
export const notFoundHandler = (req: Request, res: Response, next: NextFunction) => {
  const error = new AppError(
    404,
    `Route ${req.originalUrl} not found`,
    'NOT_FOUND',
    true
  );

  next(error);
};
```

### 3.4 APIå“åº”æ ‡å‡†åŒ–

```typescript
// backend/src/utils/apiResponse.ts
import { Response } from 'express';

// æˆåŠŸå“åº”æ ¼å¼
interface SuccessResponse<T> {
  success: true;
  data: T;
  timestamp: string;
  requestId: string;
}

// åˆ†é¡µå“åº”æ ¼å¼
interface PaginatedResponse<T> {
  success: true;
  data: T[];
  pagination: {
    page: number;
    limit: number;
    total: number;
    totalPages: number;
    hasNext: boolean;
    hasPrev: boolean;
  };
  timestamp: string;
  requestId: string;
}

// APIå“åº”å·¥å…·ç±»
export class ApiResponse {
  // æˆåŠŸå“åº”
  static success<T>(
    res: Response,
    data: T,
    statusCode: number = 200,
    requestId: string
  ): void {
    const response: SuccessResponse<T> = {
      success: true,
      data,
      timestamp: new Date().toISOString(),
      requestId
    };

    res.status(statusCode).json(response);
  }

  // åˆ†é¡µå“åº”
  static paginated<T>(
    res: Response,
    data: T[],
    pagination: {
      page: number;
      limit: number;
      total: number;
    },
    requestId: string
  ): void {
    const response: PaginatedResponse<T> = {
      success: true,
      data,
      pagination: {
        page: pagination.page,
        limit: pagination.limit,
        total: pagination.total,
        totalPages: Math.ceil(pagination.total / pagination.limit),
        hasNext: pagination.page < Math.ceil(pagination.total / pagination.limit),
        hasPrev: pagination.page > 1
      },
      timestamp: new Date().toISOString(),
      requestId
    };

    res.status(200).json(response);
  }

  // é”™è¯¯å“åº”
  static error(
    res: Response,
    error: {
      code: string;
      message: string;
      details?: any;
    },
    statusCode: number = 500,
    requestId: string
  ): void {
    const response = {
      success: false,
      error,
      timestamp: new Date().toISOString(),
      requestId
    };

    res.status(statusCode).json(response);
  }
}

// ç¤ºä¾‹ä½¿ç”¨
// åœ¨æ§åˆ¶å™¨ä¸­ä½¿ç”¨ï¼š
// import { ApiResponse } from '../utils/apiResponse';
//
// export const getUser = catchAsync(async (req: Request, res: Response) => {
//   const user = await User.findById(req.params.id);
//   ApiResponse.success(res, user, 200, req.id);
// });
```


### 3.3 è®¤è¯ä¸­é—´ä»¶

```typescript
// backend/src/middleware/auth.ts
import jwt from 'jsonwebtoken';
import { Request, Response, NextFunction } from 'express';

interface JwtPayload {
  userId: string;
  email: string;
}

declare global {
  namespace Express {
    interface Request {
      user?: JwtPayload;
    }
  }
}

export const authenticateToken = (
  req: Request,
  res: Response,
  next: NextFunction
) => {
  const authHeader = req.headers['authorization'];
  const token = authHeader?.split(' ')[1]; // Bearer TOKEN

  if (!token) {
    return res.status(401).json({ error: 'No token provided' });
  }

  try {
    const decoded = jwt.verify(
      token,
      process.env.JWT_SECRET || 'secret'
    ) as JwtPayload;
    req.user = decoded;
    next();
  } catch (error) {
    return res.status(403).json({ error: 'Invalid token' });
  }
};
```

---

## 4ï¸âƒ£ æ•°æ®åº“è®¾è®¡

### 4.1 PostgreSQL Schema (Fixed and Optimized)

```sql
-- é¦–å…ˆå®šä¹‰æšä¸¾ç±»å‹
CREATE TYPE plan_status AS ENUM ('active', 'completed', 'paused');
CREATE TYPE progress_status AS ENUM ('completed', 'in_progress', 'skipped', 'pending');
CREATE TYPE session_status AS ENUM ('completed', 'incomplete', 'paused');

-- ç”¨æˆ·è¡¨
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email VARCHAR(255) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  name VARCHAR(255) NOT NULL,
  current_clb_level SMALLINT DEFAULT 7 CHECK (current_clb_level BETWEEN 1 AND 12),
  target_clb_level SMALLINT DEFAULT 8 CHECK (target_clb_level BETWEEN 1 AND 12),
  auth_provider VARCHAR(50), -- 'email', 'google', 'wechat'
  last_login_at TIMESTAMP,
  login_count INTEGER DEFAULT 0,
  failed_login_attempts INTEGER DEFAULT 0,
  locked_until TIMESTAMP,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- æ·»åŠ ç”¨æˆ·è¡¨ç´¢å¼•
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_locked ON users(locked_until) WHERE locked_until IS NOT NULL;

-- å­¦ä¹ è®¡åˆ’è¡¨
CREATE TABLE learning_plans (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE ON UPDATE CASCADE,
  start_date DATE NOT NULL,
  end_date DATE NOT NULL CHECK (end_date > start_date),
  weeks_count SMALLINT NOT NULL CHECK (weeks_count > 0 AND weeks_count <= 52),
  status plan_status NOT NULL DEFAULT 'active',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- æ·»åŠ å­¦ä¹ è®¡åˆ’è¡¨ç´¢å¼•
CREATE INDEX idx_learning_plans_user ON learning_plans(user_id);
CREATE INDEX idx_learning_plans_dates ON learning_plans(start_date, end_date);
CREATE INDEX idx_active_plans ON learning_plans(user_id, created_at DESC) WHERE status = 'active';

-- å‘¨ä»»åŠ¡è¡¨
CREATE TABLE weekly_tasks (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  plan_id UUID NOT NULL REFERENCES learning_plans(id) ON DELETE CASCADE,
  week_number SMALLINT NOT NULL,
  task_name VARCHAR(255) NOT NULL,
  description TEXT,
  skill_category VARCHAR(50), -- 'writing', 'speaking', 'listening', 'reading'
  target_clb DECIMAL(3,1),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- æ·»åŠ å‘¨ä»»åŠ¡è¡¨ç´¢å¼•
CREATE INDEX idx_weekly_tasks_plan ON weekly_tasks(plan_id);
CREATE INDEX idx_weekly_tasks_plan_week ON weekly_tasks(plan_id, week_number);

-- èµ„æºè¡¨
CREATE TABLE resources (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  title VARCHAR(255) NOT NULL,
  description TEXT,
  type VARCHAR(50) NOT NULL, -- 'video', 'blog', 'official', 'chinese', 'practice'
  url VARCHAR(500) NOT NULL,
  source VARCHAR(100), -- 'youtube', 'hzad', 'ilac', 'bilibili', 'official'
  skill_category VARCHAR(50), -- 'listening', 'reading', 'writing', 'speaking'
  difficulty_level SMALLINT NOT NULL CHECK (difficulty_level BETWEEN 1 AND 10),
  duration_minutes SMALLINT,
  rating DECIMAL(3,2) CHECK (rating BETWEEN 0 AND 5),
  view_count INTEGER DEFAULT 0,
  is_featured BOOLEAN DEFAULT FALSE,
  is_deleted BOOLEAN DEFAULT FALSE,
  deleted_at TIMESTAMP,
  created_by UUID REFERENCES users(id) ON DELETE SET NULL,
  updated_by UUID REFERENCES users(id) ON DELETE SET NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- æ·»åŠ èµ„æºè¡¨ç´¢å¼• (ä¿®å¤è¯­æ³•é”™è¯¯)
CREATE INDEX idx_resource_search ON resources(type, skill_category, difficulty_level) WHERE is_deleted = false;
CREATE INDEX idx_resource_created ON resources(created_at DESC) WHERE is_deleted = false;
CREATE INDEX idx_resource_rating ON resources(rating DESC, view_count DESC) WHERE is_deleted = false;
CREATE INDEX idx_resource_source ON resources(source) WHERE is_deleted = false;
CREATE INDEX idx_resource_deleted ON resources(is_deleted, deleted_at);

-- èµ„æºå®Œæˆè®°å½•è¡¨
CREATE TABLE resource_completions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE ON UPDATE CASCADE,
  resource_id UUID NOT NULL REFERENCES resources(id) ON DELETE CASCADE ON UPDATE CASCADE,
  completion_time_minutes INTEGER CHECK (completion_time_minutes > 0),
  completion_rating SMALLINT CHECK (completion_rating BETWEEN 1 AND 5),
  notes TEXT,
  is_bookmarked BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(user_id, resource_id) -- é˜²æ­¢é‡å¤å®Œæˆ
);

-- æ·»åŠ èµ„æºå®Œæˆè®°å½•è¡¨ç´¢å¼•
CREATE INDEX idx_completions_user ON resource_completions(user_id);
CREATE INDEX idx_completions_resource ON resource_completions(resource_id);
CREATE INDEX idx_completions_user_resource ON resource_completions(user_id, resource_id);
CREATE INDEX idx_completions_bookmarked ON resource_completions(user_id, is_bookmarked) WHERE is_bookmarked = true;

-- è¿›åº¦è¡¨
CREATE TABLE progress (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE ON UPDATE CASCADE,
  resource_id UUID REFERENCES resources(id) ON DELETE SET NULL ON UPDATE CASCADE,
  task_id UUID REFERENCES weekly_tasks(id) ON DELETE SET NULL ON UPDATE CASCADE,
  status progress_status NOT NULL,
  completed_at TIMESTAMP,
  time_spent_minutes INTEGER DEFAULT 0,
  quality_rating SMALLINT CHECK (quality_rating BETWEEN 1 AND 5),
  notes TEXT,
  created_by UUID REFERENCES users(id) ON DELETE SET NULL,
  updated_by UUID REFERENCES users(id) ON DELETE SET NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- æ·»åŠ è¿›åº¦è¡¨ç´¢å¼• (ä¿®å¤è¯­æ³•é”™è¯¯)
CREATE INDEX idx_progress_user ON progress(user_id);
CREATE INDEX idx_progress_resource ON progress(resource_id);
CREATE INDEX idx_progress_task ON progress(task_id);
CREATE INDEX idx_progress_status ON progress(status);
CREATE INDEX idx_progress_user_status ON progress(user_id, status);
CREATE INDEX idx_progress_user_resource ON progress(user_id, resource_id);
CREATE INDEX idx_progress_completed ON progress(completed_at DESC) WHERE status = 'completed';

-- ç”¨æˆ·åå¥½è¡¨
CREATE TABLE user_preferences (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID UNIQUE NOT NULL REFERENCES users(id) ON DELETE CASCADE ON UPDATE CASCADE,
  theme VARCHAR(10) NOT NULL DEFAULT 'light' CHECK (theme IN ('light', 'dark', 'auto')),
  language VARCHAR(10) DEFAULT 'en',
  notifications_enabled BOOLEAN DEFAULT TRUE,
  email_notifications BOOLEAN DEFAULT TRUE,
  push_notifications BOOLEAN DEFAULT TRUE,
  study_reminders_enabled BOOLEAN DEFAULT TRUE,
  daily_study_goal_minutes INTEGER DEFAULT 60 CHECK (daily_study_goal_minutes > 0),
  preferred_learning_style VARCHAR(50), -- 'visual', 'auditory', 'kinesthetic', 'mixed'
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- å­¦ä¹ ä¼šè¯è¡¨
CREATE TABLE study_sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE ON UPDATE CASCADE,
  resource_id UUID REFERENCES resources(id) ON DELETE SET NULL ON UPDATE CASCADE,
  task_id UUID REFERENCES weekly_tasks(id) ON DELETE SET NULL ON UPDATE CASCADE,
  session_start_time TIMESTAMP NOT NULL,
  session_end_time TIMESTAMP,
  duration_minutes INTEGER,
  completion_status session_status,
  focus_score INTEGER CHECK (focus_score BETWEEN 0 AND 100),
  distractions_count INTEGER DEFAULT 0,
  notes TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- æ·»åŠ å­¦ä¹ ä¼šè¯è¡¨ç´¢å¼• (ä¿®å¤è¯­æ³•é”™è¯¯)
CREATE INDEX idx_sessions_user ON study_sessions(user_id);
CREATE INDEX idx_sessions_resource ON study_sessions(resource_id);
CREATE INDEX idx_sessions_task ON study_sessions(task_id);
CREATE INDEX idx_sessions_start_time ON study_sessions(session_start_time DESC);

-- ç¤¾åŒºæ•…äº‹è¡¨
CREATE TABLE community_stories (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE ON UPDATE CASCADE,
  title VARCHAR(255) NOT NULL,
  content TEXT NOT NULL,
  initial_clb SMALLINT CHECK (initial_clb BETWEEN 1 AND 12),
  final_clb SMALLINT CHECK (final_clb BETWEEN 1 AND 12),
  weeks_took SMALLINT CHECK (weeks_took > 0),
  likes_count INT DEFAULT 0,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- æ·»åŠ ç¤¾åŒºæ•…äº‹è¡¨ç´¢å¼•
CREATE INDEX idx_stories_user ON community_stories(user_id);
CREATE INDEX idx_stories_created ON community_stories(created_at DESC);

-- å¯ç”¨è¡Œçº§å®‰å…¨ç­–ç•¥ (RLS)
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
ALTER TABLE learning_plans ENABLE ROW LEVEL SECURITY;
ALTER TABLE progress ENABLE ROW LEVEL SECURITY;
ALTER TABLE resource_completions ENABLE ROW LEVEL SECURITY;
ALTER TABLE study_sessions ENABLE ROW LEVEL SECURITY;
ALTER TABLE community_stories ENABLE ROW LEVEL SECURITY;

-- åˆ›å»ºè¡Œçº§å®‰å…¨ç­–ç•¥
CREATE POLICY user_isolation ON users
  FOR ALL USING (id = current_setting('app.user_id')::UUID);

CREATE POLICY plans_isolation ON learning_plans
  FOR ALL USING (user_id = current_setting('app.user_id')::UUID);

CREATE POLICY progress_isolation ON progress
  FOR ALL USING (user_id = current_setting('app.user_id')::UUID);

CREATE POLICY completions_isolation ON resource_completions
  FOR ALL USING (user_id = current_setting('app.user_id')::UUID);

CREATE POLICY sessions_isolation ON study_sessions
  FOR ALL USING (user_id = current_setting('app.user_id')::UUID);

CREATE POLICY stories_isolation ON community_stories
  FOR ALL USING (user_id = current_setting('app.user_id')::UUID);

-- åˆ›å»ºå®¡è®¡è§¦å‘å™¨å‡½æ•°
CREATE OR REPLACE FUNCTION audit_trigger()
RETURNS TRIGGER AS $$
BEGIN
  IF TG_OP = 'INSERT' THEN
    INSERT INTO audit_logs (table_name, operation, record_id, old_values, new_values, user_id, timestamp)
    VALUES TG_TABLE_NAME, TG_OP, NEW.id, NULL, row_to_json(NEW), current_setting('app.user_id')::UUID, CURRENT_TIMESTAMP;
    RETURN NEW;
  ELSIF TG_OP = 'UPDATE' THEN
    INSERT INTO audit_logs (table_name, operation, record_id, old_values, new_values, user_id, timestamp)
    VALUES TG_TABLE_NAME, TG_OP, NEW.id, row_to_json(OLD), row_to_json(NEW), current_setting('app.user_id')::UUID, CURRENT_TIMESTAMP;
    RETURN NEW;
  ELSIF TG_OP = 'DELETE' THEN
    INSERT INTO audit_logs (table_name, operation, record_id, old_values, new_values, user_id, timestamp)
    VALUES TG_TABLE_NAME, TG_OP, OLD.id, row_to_json(OLD), NULL, current_setting('app.user_id')::UUID, CURRENT_TIMESTAMP;
    RETURN OLD;
  END IF;
  RETURN NULL;
END;
$$ LANGUAGE plpgsql;

-- åˆ›å»ºå®¡è®¡æ—¥å¿—è¡¨
CREATE TABLE audit_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  table_name VARCHAR(100) NOT NULL,
  operation VARCHAR(10) NOT NULL, -- 'INSERT', 'UPDATE', 'DELETE'
  record_id UUID NOT NULL,
  old_values JSONB,
  new_values JSONB,
  user_id UUID REFERENCES users(id),
  timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_audit_table ON audit_logs(table_name);
CREATE INDEX idx_audit_record ON audit_logs(table_name, record_id);
CREATE INDEX idx_audit_user ON audit_logs(user_id);
CREATE INDEX idx_audit_timestamp ON audit_logs(timestamp);
```

### 4.2 æ•°æ®åº“è¿ç§»è„šæœ¬

```sql
-- migrations/001_initial_schema.sql
-- åˆ›å»ºè¿ç§»è®°å½•è¡¨
CREATE TABLE schema_migrations (
  version VARCHAR(14) PRIMARY KEY,
  applied_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  description TEXT
);

-- è®°å½•è¿ç§»
INSERT INTO schema_migrations (version, description)
VALUES ('20250129_000001', 'Initial database schema with performance optimizations');

-- åˆ›å»ºç‰©åŒ–è§†å›¾ç”¨äºä»ªè¡¨æ¿
CREATE MATERIALIZED VIEW user_dashboard_summary AS
SELECT
  u.id AS user_id,
  u.current_clb_level,
  u.target_clb_level,
  COUNT(DISTINCT lp.id) AS total_plans,
  COUNT(DISTINCT p.id) FILTER (WHERE p.status = 'completed') AS completed_tasks,
  COUNT(DISTINCT rc.id) AS completed_resources,
  COALESCE(SUM(p.time_spent_minutes), 0) AS total_study_time,
  COALESCE(MAX(p.completed_at), u.created_at) AS last_activity_at,
  COUNT(DISTINCT cs.id) AS community_stories
FROM users u
LEFT JOIN learning_plans lp ON u.id = lp.user_id
LEFT JOIN progress p ON u.id = p.user_id
LEFT JOIN resource_completions rc ON u.id = rc.user_id
LEFT JOIN community_stories cs ON u.id = cs.user_id
GROUP BY u.id, u.current_clb_level, u.target_clb_level;

CREATE UNIQUE INDEX idx_dashboard_summary_user ON user_dashboard_summary(user_id);

-- åˆ›å»ºç‰©åŒ–è§†å›¾åˆ·æ–°å‡½æ•°
CREATE OR REPLACE FUNCTION refresh_dashboard_summary()
RETURNS void AS $$
BEGIN
  REFRESH MATERIALIZED VIEW CONCURRENTLY user_dashboard_summary;
END;
$$ LANGUAGE plpgsql;

-- åˆ›å»ºå…¨æ–‡æœç´¢åŠŸèƒ½
ALTER TABLE resources ADD COLUMN search_vector tsvector;
CREATE INDEX idx_resources_search ON resources USING GIN(search_vector);

CREATE OR REPLACE FUNCTION resources_search_trigger()
RETURNS trigger AS $$
BEGIN
  NEW.search_vector :=
    setweight(to_tsvector('english', coalesce(NEW.title, '')), 'A') ||
    setweight(to_tsvector('english', coalesce(NEW.description, '')), 'B');
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER tsvector_update
BEFORE INSERT OR UPDATE ON resources
FOR EACH ROW EXECUTE FUNCTION resources_search_trigger();

-- åˆ›å»ºç´¢å¼•ä¼˜åŒ–å»ºè®®çš„æ±‡æ€»ç´¢å¼•
CREATE INDEX idx_composite_user_progress
ON progress(user_id, status, created_at DESC);

CREATE INDEX idx_composite_resource_completions
ON resource_completions(user_id, is_bookmarked, created_at DESC);

-- åˆ›å»ºéƒ¨åˆ†ç´¢å¼•ç”¨äºæ´»è·ƒæ•°æ®
CREATE INDEX idx_active_learning_plans
ON learning_plans(user_id, created_at DESC)
WHERE status = 'active';

CREATE INDEX idx_recent_progress
ON progress(user_id, completed_at DESC)
WHERE completed_at > CURRENT_TIMESTAMP - INTERVAL '30 days';

-- æ€§èƒ½ç»Ÿè®¡è§†å›¾
CREATE OR REPLACE VIEW performance_stats AS
SELECT
  schemaname,
  tablename,
  attname,
  n_distinct,
  correlation
FROM pg_stats
WHERE schemaname = 'public'
  AND tablename IN ('users', 'learning_plans', 'resources', 'progress', 'resource_completions')
ORDER BY tablename, attname;
```

### 4.3 PostgreSQL è¡¨æ‰©å±•ï¼ˆJSONBå’Œæ—¶é—´åºåˆ—ï¼‰

```sql
-- ç”¨æˆ·ç¬”è®°è¡¨ï¼ˆä½¿ç”¨JSONBå­˜å‚¨çµæ´»æ•°æ®ï¼‰
CREATE TABLE IF NOT EXISTS user_notes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  resource_id UUID REFERENCES resources(id),
  content TEXT NOT NULL,
  note_type VARCHAR(20) NOT NULL CHECK (note_type IN ('writing', 'speaking', 'listening', 'reading')),
  tags TEXT[] DEFAULT '{}',
  metadata JSONB DEFAULT '{}',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  is_deleted BOOLEAN DEFAULT FALSE
);

-- äº‹ä»¶æ—¥å¿—è¡¨ï¼ˆæ—¶é—´åºåˆ—æ•°æ®ï¼‰
CREATE TABLE IF NOT EXISTS event_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE SET NULL,
  event_type VARCHAR(50) NOT NULL,
  event_data JSONB NOT NULL,
  metadata JSONB DEFAULT '{}',
  timestamp TIMESTAMPTZ DEFAULT NOW()
);

-- ä¸ºäº‹ä»¶æ—¥å¿—åˆ›å»ºåˆ†åŒºè¡¨ï¼ˆæŒ‰æœˆåˆ†åŒºï¼‰
CREATE TABLE event_logs_2025_01 PARTITION OF event_logs
  FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');

-- åˆ›å»ºç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
CREATE INDEX idx_user_notes_user_id ON user_notes(user_id) WHERE is_deleted = false;
CREATE INDEX idx_user_notes_resource_id ON user_notes(resource_id) WHERE is_deleted = false;
CREATE INDEX idx_event_logs_timestamp ON event_logs(timestamp);
CREATE INDEX idx_event_logs_type ON event_logs(event_type);
```

```sql
-- åˆ›å»ºè§¦å‘å™¨å‡½æ•°ï¼ˆè‡ªåŠ¨æ›´æ–°updated_atï¼‰
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';

-- ä¸ºuser_notesè¡¨æ·»åŠ è§¦å‘å™¨
CREATE TRIGGER update_user_notes_updated_at
    BEFORE UPDATE ON user_notes
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();
```

---

## 5ï¸âƒ£ å“åº”å¼è®¾è®¡å®ç°ç»†èŠ‚

### 5.1 Mobile-First CSSç­–ç•¥

```css
/* styles/responsive.css */

/* ========== BASE (Mobile First) ========== */
body {
  font-size: 14px;
  line-height: 1.5;
}

.container {
  width: 100%;
  padding: 0 16px;
}

.grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 16px;
}

.button {
  width: 100%;
  padding: 12px;
  font-size: 14px;
}

header {
  padding: 16px;
  height: auto;
}

/* ========== TABLET (md: 769px) ========== */
@media (min-width: 769px) {
  body {
    font-size: 16px;
  }

  .container {
    max-width: 750px;
    margin: 0 auto;
    padding: 0 24px;
  }

  .grid {
    grid-template-columns: repeat(2, 1fr);
    gap: 24px;
  }

  .button {
    width: auto;
    padding: 12px 24px;
  }

  header {
    height: 60px;
    display: flex;
    align-items: center;
  }
}

/* ========== DESKTOP (lg: 1025px) ========== */
@media (min-width: 1025px) {
  .container {
    max-width: 1200px;
  }

  .grid {
    grid-template-columns: repeat(3, 1fr);
  }

  header {
    padding: 0 40px;
  }

  aside {
    display: block;
    width: 250px;
  }
}

/* ========== LARGE DESKTOP (xl: 1441px) ========== */
@media (min-width: 1441px) {
  .container {
    max-width: 1400px;
  }

  .grid {
    grid-template-columns: repeat(4, 1fr);
    gap: 32px;
  }
}

/* ========== è§¦æ§ä¼˜åŒ– ========== */
@media (hover: none) and (pointer: coarse) {
  button, a {
    min-height: 44px; /* iOSå¯è®¿é—®æ€§æ ‡å‡† */
    min-width: 44px;
  }

  button:active {
    background-color: rgba(0, 0, 0, 0.1);
  }
}

/* ========== Safe Areaæ”¯æŒ (iPhone X+) ========== */
@supports (padding: max(0px)) {
  body {
    padding-left: max(16px, env(safe-area-inset-left));
    padding-right: max(16px, env(safe-area-inset-right));
    padding-bottom: max(16px, env(safe-area-inset-bottom));
  }
}

/* ========== æš—é»‘æ¨¡å¼ ========== */
@media (prefers-color-scheme: dark) {
  body {
    background-color: #1a1a1a;
    color: #ffffff;
  }

  .card {
    background-color: #2a2a2a;
    border-color: #444444;
  }
}

/* ========== å‡é€ŸåŠ¨ç”» ========== */
@media (prefers-reduced-motion: reduce) {
  * {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
}
```

### 5.2 å“åº”å¼å›¾ç‰‡å¤„ç†

```typescript
// components/ResponsiveImage.tsx
import Image from 'next/image';

interface ResponsiveImageProps {
  src: string;
  alt: string;
  title?: string;
  priority?: boolean;
}

export const ResponsiveImage: React.FC<ResponsiveImageProps> = ({
  src,
  alt,
  title,
  priority = false,
}) => {
  return (
    <div className="relative w-full h-auto">
      <Image
        src={src}
        alt={alt}
        title={title}
        priority={priority}
        responsive
        sizes="
          (max-width: 480px) 100vw,
          (max-width: 768px) 90vw,
          (max-width: 1024px) 80vw,
          (max-width: 1440px) 70vw,
          60vw
        "
        style={{
          width: '100%',
          height: 'auto',
        }}
      />
    </div>
  );
};
```

---

## 6ï¸âƒ£ è®¤è¯å’Œæˆæƒ

### 6.1 å®‰å…¨çš„ JWT Token æµç¨‹è®¾è®¡

```
1. å®‰å…¨ç™»å½•æµç¨‹
   â”œâ”€ å‰ç«¯å‘é€ credentials
   â”œâ”€ åç«¯éªŒè¯å‡­è¯
   â”œâ”€ ç”Ÿæˆ JWT Access Token (15åˆ†é’Ÿ)
   â”œâ”€ ç”Ÿæˆ Refresh Token (7å¤©) + ROTATION TOKEN
   â”œâ”€ ä¿å­˜ Refresh Token Hash åˆ°æ•°æ®åº“ (HttpOnly Cookie)
   â””â”€ è¿”å› Access Token åˆ°å†…å­˜å­˜å‚¨

2. å—ä¿æŠ¤èµ„æºè¯·æ±‚
   â”œâ”€ ä»å†…å­˜è·å– Access Token
   â”œâ”€ æ·»åŠ åˆ° Authorization header: Bearer <token>
   â”œâ”€ åç«¯éªŒè¯: ç­¾å + è¿‡æœŸæ—¶é—´ + é»‘åå•æ£€æŸ¥
   â”œâ”€ Tokenæœ‰æ•ˆ â†’ æ‰§è¡Œè¯·æ±‚
   â””â”€ Tokenå³å°†è¿‡æœŸ(5åˆ†é’Ÿå†…) â†’ è‡ªåŠ¨åˆ·æ–°

3. Token åˆ·æ–°æµç¨‹ (with Rotation)
   â”œâ”€ å‘é€ Refresh Token åˆ° /auth/refresh
   â”œâ”€ åç«¯éªŒè¯: å­˜åœ¨æ€§ + æœ‰æ•ˆæ€§ + æœªè¿‡æœŸ
   â”œâ”€ ç”Ÿæˆæ–°çš„ Access Token + æ–°çš„ Refresh Token
   â”œâ”€ å°†æ—§ Refresh Token åŠ å…¥é»‘åå•
   â”œâ”€ ä¿å­˜æ–° Refresh Token Hash
   â””â”€ è¿”å›æ–°çš„ Token å¯¹

4. å®‰å…¨ç™»å‡º
   â”œâ”€ å°† Refresh Token åŠ å…¥é»‘åå•
   â”œâ”€ æ¸…é™¤å‰ç«¯å­˜å‚¨çš„ Access Token
   â”œâ”€ æ¸…é™¤ Session æ•°æ®
   â””â”€ è¿”å›æˆåŠŸçŠ¶æ€
```

### 6.2 å¢å¼ºçš„å®‰å…¨å®ç°

```typescript
// backend/src/models/tokens.ts
interface RefreshToken {
  id: string;
  userId: string;
  tokenHash: string; // bcrypt hash
  createdAt: Date;
  expiresAt: Date;
  rotatedAt?: Date;
  isBlacklisted: boolean;
  userAgent?: string;
  ipAddress?: string;
}

// backend/src/services/authService.ts
import bcrypt from 'bcrypt';
import jwt from 'jsonwebtoken';
import crypto from 'crypto';

class AuthService {
  private readonly refreshTokenExpiry = 7 * 24 * 60 * 60 * 1000; // 7 days
  private readonly accessTokenExpiry = 15 * 60 * 1000; // 15 minutes
  private readonly refreshWindow = 5 * 60 * 1000; // 5 minutes before expiry

  // ç”Ÿæˆå®‰å…¨çš„ Token å¯¹
  generateTokenPair(userId: string) {
    const accessToken = this.generateAccessToken(userId);
    const refreshToken = this.generateRefreshToken();
    const hashedToken = bcrypt.hashSync(refreshToken, 10);

    return {
      accessToken,
      refreshToken,
      accessTokenExpires: new Date(Date.now() + this.accessTokenExpiry),
      refreshTokenExpires: new Date(Date.now() + this.refreshTokenExpiry),
      hashedToken
    };
  }

  // éªŒè¯å¹¶è½®æ¢ Refresh Token
  async rotateRefreshToken(token: string): Promise<{
    accessToken: string;
    refreshToken: string;
    expiresAt: Date;
  }> {
    const tokenData = await this.findRefreshToken(token);

    if (!tokenData || tokenData.isBlacklisted) {
      throw new Error('Invalid refresh token');
    }

    // æ£€æŸ¥æ˜¯å¦éœ€è¦è½®æ¢
    const shouldRotate = Date.now() > tokenData.expiresAt.getTime() - this.refreshWindow;

    if (shouldRotate) {
      // ç”Ÿæˆæ–°çš„ token å¯¹
      const newTokenPair = this.generateTokenPair(tokenData.userId);

      // é»‘åå•æ—§ token
      await this.blacklistRefreshToken(tokenData.id);

      // ä¿å­˜æ–° token
      await this.saveRefreshToken({
        userId: tokenData.userId,
        tokenHash: newTokenPair.hashedToken,
        expiresAt: newTokenPair.refreshTokenExpires,
        userAgent: tokenData.userAgent,
        ipAddress: tokenData.ipAddress
      });

      return {
        accessToken: newTokenPair.accessToken,
        refreshToken: newTokenPair.refreshToken,
        expiresAt: newTokenPair.refreshTokenExpires
      };
    }

    // ä»…è¿”å›æ–°çš„ access token
    return {
      accessToken: this.generateAccessToken(tokenData.userId),
      refreshToken: token,
      expiresAt: tokenData.expiresAt
    };
  }

  // å®‰å…¨çš„ç™»å‡ºå¤„ç†
  async logout(refreshToken: string): Promise<void> {
    if (refreshToken) {
      await this.blacklistRefreshToken(refreshToken);
    }
    // æ¸…é™¤ç”¨æˆ·ä¼šè¯æ•°æ®
    await this.clearUserSession();
  }
}

// å‰ç«¯å®‰å…¨å­˜å‚¨
class SecureTokenStorage {
  private static instance: SecureTokenStorage;
  private accessToken: string | null = null;

  static getInstance(): SecureTokenStorage {
    if (!SecureTokenStorage.instance) {
      SecureTokenStorage.instance = new SecureTokenStorage();
    }
    return SecureTokenStorage.instance;
  }

  // å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œé¡µé¢åˆ·æ–°åä¸¢å¤±
  setAccessToken(token: string): void {
    this.accessToken = token;
    // è®¾ç½®è¿‡æœŸæé†’
    this.scheduleTokenRefresh();
  }

  getAccessToken(): string | null {
    return this.accessToken;
  }

  // æ¸…é™¤å†…å­˜ä¸­çš„ token
  clearAccessToken(): void {
    this.accessToken = null;
    this.clearRefreshSchedule();
  }

  // è‡ªåŠ¨åˆ·æ–°æœºåˆ¶
  private scheduleTokenRefresh(): void {
    // åœ¨ token è¿‡æœŸå‰ 5 åˆ†é’Ÿåˆ·æ–°
    setTimeout(() => {
      this.refreshAccessToken();
    }, 10 * 60 * 1000); // 10 minutes
  }

  private async refreshAccessToken(): Promise<void> {
    try {
      const refreshToken = this.getRefreshTokenFromCookie();
      const response = await fetch('/api/auth/refresh', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ refreshToken }),
        credentials: 'include' // ç¡®ä¿ cookie è¢«å‘é€
      });

      if (response.ok) {
        const data = await response.json();
        this.setAccessToken(data.accessToken);
      }
    } catch (error) {
      console.error('Token refresh failed:', error);
      this.handleAuthFailure();
    }
  }

  private handleAuthFailure(): void {
    // æ¸…é™¤æ‰€æœ‰è®¤è¯æ•°æ®
    this.clearAccessToken();
    // é‡å®šå‘åˆ°ç™»å½•é¡µ
    window.location.href = '/auth/login';
  }

  // ä» HttpOnly cookie è·å– refresh token
  private getRefreshTokenFromCookie(): string | null {
    const cookies = document.cookie.split(';');
    for (const cookie of cookies) {
      const [name, value] = cookie.trim().split('=');
      if (name === 'refreshToken') {
        return value;
      }
    }
    return null;
  }
}
```

### 6.3 å®‰å…¨ä¸­é—´ä»¶å®ç°

```typescript
// backend/src/middleware/auth.ts
import { Request, Response, NextFunction } from 'express';
import jwt from 'jsonwebtoken';
import { AuthService } from '../services/authService';

declare global {
  namespace Express {
    interface Request {
      user?: {
        id: string;
        email: string;
      };
    }
  }
}

export const authenticateToken = async (
  req: Request,
  res: Response,
  next: NextFunction
) => {
  const authHeader = req.headers['authorization'];
  const token = authHeader?.split(' ')[1]; // Bearer TOKEN

  if (!token) {
    return res.status(401).json({
      error: 'Access token required',
      code: 'ACCESS_TOKEN_REQUIRED'
    });
  }

  try {
    // éªŒè¯ token ç­¾å
    const decoded = jwt.verify(
      token,
      process.env.JWT_SECRET!
    ) as { userId: string; email: string };

    // æ£€æŸ¥æ˜¯å¦åœ¨é»‘åå•ä¸­
    const authService = new AuthService();
    const isBlacklisted = await authService.isTokenBlacklisted(token);

    if (isBlacklisted) {
      return res.status(401).json({
        error: 'Token revoked',
        code: 'TOKEN_REVOKED'
      });
    }

    req.user = decoded;
    next();
  } catch (error) {
    if (error instanceof jwt.JsonWebTokenError) {
      return res.status(403).json({
        error: 'Invalid token',
        code: 'INVALID_TOKEN'
      });
    }

    if (error instanceof jwt.TokenExpiredError) {
      return res.status(401).json({
        error: 'Token expired',
        code: 'TOKEN_EXPIRED',
        expired: true // å‰ç«¯å¯ä»¥ä½¿ç”¨è¿™ä¸ªä¿¡æ¯è‡ªåŠ¨åˆ·æ–°
      });
    }

    return res.status(500).json({
      error: 'Authentication failed',
      code: 'AUTH_FAILED'
    });
  }
};

// é€Ÿç‡é™åˆ¶ä¸­é—´ä»¶
export const authRateLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15åˆ†é’Ÿ
  max: 5, // æœ€å¤š5æ¬¡å°è¯•
  message: {
    error: 'Too many authentication attempts',
    code: 'TOO_MANY_ATTEMPTS',
    retryAfter: 900 // 15åˆ†é’Ÿåé‡è¯•
  },
  standardHeaders: true,
  legacyHeaders: false,
});

// å®‰å…¨å¤´ä¸­é—´ä»¶
export const securityHeaders = (req: Request, res: Response, next: NextFunction) => {
  res.setHeader('X-Content-Type-Options', 'nosniff');
  res.setHeader('X-Frame-Options', 'DENY');
  res.setHeader('X-XSS-Protection', '1; mode=block');
  res.setHeader('Referrer-Policy', 'strict-origin-when-cross-origin');
  res.setHeader('Content-Security-Policy',
    "default-src 'self'; " +
    "script-src 'self' 'unsafe-inline' 'unsafe-eval'; " +
    "style-src 'self' 'unsafe-inline'; " +
    "img-src 'self' data: https:; " +
    "connect-src 'self' https://api.celpip-compass.com;"
  );
  next();
};
```

---

## 7ï¸âƒ£ é›†æˆå’Œéƒ¨ç½²

### 7.1 CI/CD Pipeline (GitHub Actions)

```yaml
# .github/workflows/build-and-deploy.yml
name: Build and Deploy

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Run tests
        run: npm run test
        env:
          DATABASE_URL: postgres://postgres:postgres@localhost:5432/test_db

      - name: Build
        run: npm run build

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v3

      - name: Deploy to Vercel
        uses: vercel/action@master
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
```

### 7.2 å®¹å™¨åŒ–éƒ¨ç½²

```dockerfile
# frontend/Dockerfile
FROM node:18-alpine AS builder
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
RUN npm run build

FROM node:18-alpine
WORKDIR /app
RUN npm install -g next
COPY --from=builder /app/.next ./.next
COPY --from=builder /app/public ./public
COPY --from=builder /app/package*.json ./
RUN npm ci --only=production
EXPOSE 3000
CMD ["next", "start"]
```

### 7.3 Kuberneteséƒ¨ç½²é…ç½®

```yaml
# k8s/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: celpip-compass-frontend
spec:
  replicas: 3
  selector:
    matchLabels:
      app: celpip-compass-frontend
  template:
    metadata:
      labels:
        app: celpip-compass-frontend
    spec:
      containers:
      - name: frontend
        image: celpip-compass-frontend:latest
        ports:
        - containerPort: 3000
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /
            port: 3000
          initialDelaySeconds: 30
          periodSeconds: 10

---
apiVersion: v1
kind: Service
metadata:
  name: celpip-compass-frontend
spec:
  selector:
    app: celpip-compass-frontend
  ports:
  - protocol: TCP
    port: 80
    targetPort: 3000
  type: LoadBalancer
```

---

## 8ï¸âƒ£ æµ‹è¯•ç­–ç•¥

### 8.1 å•å…ƒæµ‹è¯• (Jest)

```typescript
// components/__tests__/Card.test.tsx
import { render, screen } from '@testing-library/react';
import { Card } from '../Card';

describe('Card Component', () => {
  it('renders with title', () => {
    render(<Card title="Test Title">Test Content</Card>);
    expect(screen.getByText('Test Title')).toBeInTheDocument();
  });

  it('renders responsive classes', () => {
    const { container } = render(<Card>Test</Card>);
    expect(container.firstChild).toHaveClass('p-4', 'sm:p-6', 'md:p-8');
  });

  it('handles button click', () => {
    const handleClick = jest.fn();
    render(
      <Card
        onAction={handleClick}
        actionLabel="Click me"
      >
        Test
      </Card>
    );
    
    const button = screen.getByText('Click me');
    button.click();
    expect(handleClick).toHaveBeenCalled();
  });
});
```

### 8.2 E2Eæµ‹è¯• (Playwright)

```typescript
// e2e/auth.spec.ts
import { test, expect } from '@playwright/test';

test.describe('Authentication', () => {
  test('should login successfully', async ({ page }) => {
    await page.goto('http://localhost:3000/auth/login');
    
    // å¡«å……è¡¨å•
    await page.fill('input[name="email"]', 'test@example.com');
    await page.fill('input[name="password"]', 'password123');
    
    // æäº¤
    await page.click('button[type="submit"]');
    
    // éªŒè¯é‡å®šå‘
    await expect(page).toHaveURL('http://localhost:3000/dashboard');
  });

  test('should be responsive on mobile', async ({ page }) => {
    await page.setViewportSize({ width: 375, height: 667 });
    await page.goto('http://localhost:3000/auth/login');
    
    // éªŒè¯ç§»åŠ¨èœå•
    const hamburger = await page.$('[data-testid="hamburger-menu"]');
    expect(hamburger).toBeTruthy();
  });
});
```

### 8.3 æ€§èƒ½æµ‹è¯•

```typescript
// tests/performance.test.ts
import { test, expect } from '@playwright/test';

test('page should load within 2 seconds', async ({ page }) => {
  const startTime = Date.now();

  await page.goto('http://localhost:3000/dashboard');
  await page.waitForLoadState('networkidle');

  const loadTime = Date.now() - startTime;
  expect(loadTime).toBeLessThan(2000);
});

test('LCP should be less than 2.5 seconds', async ({ page }) => {
  await page.goto('/');

  // ç›‘å¬ LCP
  const lcpMetric = await page.evaluate(() => {
    return new Promise((resolve) => {
      new PerformanceObserver((list) => {
        const entries = list.getEntries();
        const lcpEntry = entries[entries.length - 1];
        resolve(lcpEntry.startTime);
      }).observe({ entryTypes: ['largest-contentful-paint'] });
    });
  });

  expect(lcpMetric).toBeLessThan(2500);
});
```

---

## 9ï¸âƒ£ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 9.1 å‰ç«¯æ€§èƒ½ä¼˜åŒ–

#### **ä»£ç åˆ†å‰²å’Œæ‡’åŠ è½½**
```typescript
// src/app/learning/page.tsx - æ‡’åŠ è½½å­¦ä¹ æ¨¡å—
import { lazy, Suspense } from 'react';
import { LoadingSpinner } from '@/components/ui/loading';

const LearningDashboard = lazy(() => import('@/components/features/learning/dashboard'));
const ResourceLibrary = lazy(() => import('@/components/features/learning/resource-library'));

export default function LearningPage() {
  return (
    <div className="min-h-screen bg-gray-50">
      <Suspense fallback={<LoadingSpinner />}>
        <LearningDashboard />
      </Suspense>
      <Suspense fallback={<LoadingSpinner />}>
        <ResourceLibrary />
      </Suspense>
    </div>
  );
}

// ä½¿ç”¨åŠ¨æ€å¯¼å…¥ API è·¯ç”±
export const dynamic = 'force-dynamic';
```

#### **å›¾ç‰‡ä¼˜åŒ–**
```typescript
// src/components/ui/optimized-image.tsx
'use client';

import Image from 'next/image';
import { useState } from 'react';

interface OptimizedImageProps {
  src: string;
  alt: string;
  width?: number;
  height?: number;
  priority?: boolean;
  className?: string;
}

export function OptimizedImage({
  src,
  alt,
  width,
  height,
  priority = false,
  className
}: OptimizedImageProps) {
  const [isLoading, setIsLoading] = useState(true);
  const [hasError, setHasError] = useState(false);

  return (
    <div className={`relative ${className}`}>
      {isLoading && (
        <div className="absolute inset-0 bg-gray-200 animate-pulse" />
      )}

      <Image
        src={src}
        alt={alt}
        width={width || 800}
        height={height || 600}
        priority={priority}
        quality={75}
        sizes="(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw"
        onLoad={() => setIsLoading(false)}
        onError={() => setHasError(true)}
        className={`transition-opacity duration-300 ${
          isLoading ? 'opacity-0' : 'opacity-100'
        }`}
      />

      {hasError && (
        <div className="absolute inset-0 flex items-center justify-center bg-gray-100">
          <span className="text-gray-400">Image not available</span>
        </div>
      )}
    </div>
  );
}
```

#### **è™šæ‹ŸåŒ–é•¿åˆ—è¡¨**
```typescript
// src/components/ui/virtualized-list.tsx
'use client';

import { useMemo, useState, useRef, useEffect } from 'react';
import { FixedSizeList as List } from 'react-window';

interface VirtualizedListProps {
  items: any[];
  itemHeight: number;
  renderItem: (item: any, index: number) => React.ReactNode;
  height: number;
}

export function VirtualizedList({
  items,
  itemHeight,
  renderItem,
  height
}: VirtualizedListProps) {
  const Row = ({ index, style }: { index: number; style: any }) => (
    <div style={style}>
      {renderItem(items[index], index)}
    </div>
  );

  return (
    <List
      height={height}
      itemCount={items.length}
      itemSize={itemHeight}
      width="100%"
    >
      {Row}
    </List>
  );
}

// ä½¿ç”¨ç¤ºä¾‹
// <VirtualizedList
//   items={resources}
//   itemHeight={200}
//   height={600}
//   renderItem={(resource) => <ResourceCard resource={resource} />}
// />
```

#### **ç¼“å­˜ç­–ç•¥**
```typescript
// src/lib/cache.ts
class CacheManager {
  private cache: Map<string, { data: any; timestamp: number; ttl: number }>;
  private maxSize: number;

  constructor(maxSize: number = 100) {
    this.cache = new Map();
    this.maxSize = maxSize;
  }

  // è®¾ç½®ç¼“å­˜
  set(key: string, data: any, ttl: number = 5 * 60 * 1000): void {
    if (this.cache.size >= this.maxSize) {
      // åˆ é™¤æœ€æ—§çš„ç¼“å­˜é¡¹
      const oldestKey = this.cache.keys().next().value;
      this.cache.delete(oldestKey);
    }

    this.cache.set(key, {
      data,
      timestamp: Date.now(),
      ttl
    });
  }

  // è·å–ç¼“å­˜
  get(key: string): any | null {
    const item = this.cache.get(key);

    if (!item) {
      return null;
    }

    // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
    if (Date.now() - item.timestamp > item.ttl) {
      this.cache.delete(key);
      return null;
    }

    return item.data;
  }

  // åˆ é™¤ç¼“å­˜
  delete(key: string): void {
    this.cache.delete(key);
  }

  // æ¸…ç©ºç¼“å­˜
  clear(): void {
    this.cache.clear();
  }

  // é¢„ç¼“å­˜
  preCache(items: Array<{ key: string; data: any; ttl?: number }>): void {
    items.forEach(item => {
      this.set(item.key, item.data, item.ttl);
    });
  }
}

// å…¨å±€ç¼“å­˜å®ä¾‹
export const cacheManager = new CacheManager();

// APIç¼“å­˜Hook
export function useApiCache<T>(key: string, fetchFn: () => Promise<T>, ttl: number = 5 * 60 * 1000) {
  const [data, setData] = useState<T | null>(null);
  const [isLoading, setIsLoading] = useState(false);

  const fetchData = async () => {
    // æ£€æŸ¥ç¼“å­˜
    const cachedData = cacheManager.get(key);
    if (cachedData) {
      setData(cachedData);
      return;
    }

    setIsLoading(true);
    try {
      const result = await fetchFn();
      setData(result);
      // ç¼“å­˜ç»“æœ
      cacheManager.set(key, result, ttl);
    } catch (error) {
      console.error('Fetch error:', error);
    } finally {
      setIsLoading(false);
    }
  };

  return { data, isLoading, refetch: fetchData };
}
```

### 9.2 åç«¯æ€§èƒ½ä¼˜åŒ–

#### **Redisç¼“å­˜ç­–ç•¥**
```typescript
// backend/src/services/cacheService.ts
import { createClient } from 'redis';
import { promisify } from 'util';

class CacheService {
  private client: any;
  private getAsync: any;
  private setAsync: any;
  private delAsync: any;
  private existsAsync: any;

  constructor() {
    this.client = createClient({
      host: process.env.REDIS_HOST || 'localhost',
      port: parseInt(process.env.REDIS_PORT || '6379'),
      password: process.env.REDIS_PASSWORD,
      retry_strategy: (options: any) => {
        if (options.error && options.error.code === 'ECONNREFUSED') {
          // æœåŠ¡å™¨æ‹’ç»è¿æ¥
          return new Error('Redis server refused connection');
        }

        if (options.total_retry_time > 1000 * 60 * 60) {
          // æ€»é‡è¯•æ—¶é—´è¶…è¿‡1å°æ—¶
          return new Error('Redis retry timeout exhausted');
        }

        if (options.attempts > 10) {
          // é‡è¯•æ¬¡æ•°è¶…è¿‡10æ¬¡
          return undefined;
        }

        // é‡è¯•é—´éš”æŒ‡æ•°é€€é¿
        return Math.min(options.attempts * 100, 3000);
      }
    });

    this.getAsync = promisify(this.client.get).bind(this.client);
    this.setAsync = promisify(this.client.set).bind(this.client);
    this.delAsync = promisify(this.client.del).bind(this.client);
    this.existsAsync = promisify(this.client.exists).bind(this.client);
  }

  // è®¾ç½®ç¼“å­˜
  async set(key: string, value: any, ttl: number = 3600): Promise<void> {
    await this.setAsync(key, JSON.stringify(value), 'EX', ttl);
  }

  // è·å–ç¼“å­˜
  async get<T>(key: string): Promise<T | null> {
    const value = await this.getAsync(key);
    if (!value) return null;

    try {
      return JSON.parse(value);
    } catch {
      return null;
    }
  }

  // åˆ é™¤ç¼“å­˜
  async del(key: string): Promise<void> {
    await this.delAsync(key);
  }

  // æ£€æŸ¥ç¼“å­˜æ˜¯å¦å­˜åœ¨
  async exists(key: string): Promise<boolean> {
    return (await this.existsAsync(key)) === 1;
  }

  // ç¼“å­˜æ¨¡å¼ï¼šå¸ƒéš†è¿‡æ»¤å™¨
  async addToBloomFilter(filterName: string, item: string): Promise<void> {
    await this.client.send_command(['BF.ADD', filterName, item]);
  }

  async checkBloomFilter(filterName: string, item: string): Promise<boolean> {
    const result = await this.client.send_command(['BF.EXISTS', filterName, item]);
    return result === 1;
  }

  // ç¼“å­˜é¢„çƒ­
  async warmUp(): Promise<void> {
    const resources = await this.getPopularResources();
    const cachedResources = resources.map(resource => ({
      key: `resource:${resource.id}`,
      data: resource,
      ttl: 3600
    }));

    this.preCache(cachedResources);
  }

  // åˆ†é¡µç¼“å­˜
  async getPaginatedCacheKey(baseKey: string, page: number, limit: number): string {
    return `${baseKey}:page:${page}:limit:${limit}`;
  }

  // è·å–æˆ–è®¾ç½®æ¨¡å¼
  async getOrSet<T>(
    key: string,
    fetchFn: () => Promise<T>,
    ttl: number = 3600
  ): Promise<T> {
    const cached = await this.get<T>(key);
    if (cached) return cached;

    const data = await fetchFn();
    await this.set(key, data, ttl);
    return data;
  }
}

export const cacheService = new CacheService();
```

#### **æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–**
```typescript
// backend/src/services/databaseOptimization.ts
import { pool } from '../config/database';

class DatabaseOptimization {
  // æ‰¹é‡æ’å…¥ä¼˜åŒ–
  async batchInsert(table: string, data: any[]): Promise<void> {
    const columns = Object.keys(data[0]);
    const values = data.map(row =>
      columns.map(col => `'${row[col]}'`).join(', ')
    );

    const query = `
      INSERT INTO ${table} (${columns.join(', ')})
      VALUES ${values.map(v => `(${v})`).join(', ')}
      ON CONFLICT DO NOTHING
    `;

    await pool.query(query);
  }

  // åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–
  async getPaginatedData(
    table: string,
    page: number,
    limit: number,
    orderBy: string = 'created_at',
    order: 'ASC' | 'DESC' = 'DESC'
  ) {
    const offset = (page - 1) * limit;

    const query = `
      SELECT * FROM ${table}
      WHERE is_deleted = false
      ORDER BY ${orderBy} ${order}
      LIMIT $1 OFFSET $2
    `;

    const countQuery = `
      SELECT COUNT(*) FROM ${table}
      WHERE is_deleted = false
    `;

    const [data, countResult] = await Promise.all([
      pool.query(query, [limit, offset]),
      pool.query(countQuery)
    ]);

    return {
      data: data.rows,
      pagination: {
        page,
        limit,
        total: parseInt(countResult.rows[0].count),
        totalPages: Math.ceil(parseInt(countResult.rows[0].count) / limit)
      }
    };
  }

  // å¤åˆç´¢å¼•æŸ¥è¯¢ä¼˜åŒ–
  async getResourcesByFilters(filters: {
    skillCategory?: string;
    type?: string;
    difficultyLevel?: number;
    limit?: number;
  }) {
    const conditions = [];
    const params = [];
    let paramIndex = 1;

    if (filters.skillCategory) {
      conditions.push(`skill_category = $${paramIndex++}`);
      params.push(filters.skillCategory);
    }

    if (filters.type) {
      conditions.push(`type = $${paramIndex++}`);
      params.push(filters.type);
    }

    if (filters.difficultyLevel) {
      conditions.push(`difficulty_level = $${paramIndex++}`);
      params.push(filters.difficultyLevel);
    }

    const whereClause = conditions.length > 0
      ? `WHERE ${conditions.join(' AND ')} AND is_deleted = false`
      : 'WHERE is_deleted = false';

    const query = `
      SELECT * FROM resources
      ${whereClause}
      ORDER BY rating DESC, view_count DESC
      LIMIT $${paramIndex++}
    `;

    params.push(filters.limit || 20);

    const result = await pool.query(query, params);
    return result.rows;
  }

  // ç‰©åŒ–è§†å›¾
  async createMaterializedView(): Promise<void> {
    const query = `
      CREATE MATERIALIZED VIEW IF NOT EXISTS user_progress_summary AS
      SELECT
        u.id as user_id,
        COUNT(p.id) as total_completed,
        SUM(p.time_spent_minutes) as total_time_spent,
        AVG(p.quality_rating) as avg_rating,
        MAX(p.completed_at) as last_completed_at
      FROM users u
      LEFT JOIN progress p ON u.id = p.user_id AND p.status = 'completed'
      GROUP BY u.id;
    `;

    await pool.query(query);
  }

  // åˆ·æ–°ç‰©åŒ–è§†å›¾
  async refreshMaterializedView(): Promise<void> {
    await pool.query('REFRESH MATERIALIZED VIEW user_progress_summary');
  }
}

export const dbOptimization = new DatabaseOptimization();
```

### 9.3 CDNå’Œèµ„æºä¼˜åŒ–

#### **é™æ€èµ„æºCDNé…ç½®**
```typescript
// next.config.js
/** @type {import('next').NextConfig} */
const nextConfig = {
  images: {
    domains: ['img.youtube.com', 'storage.googleapis.com'],
    formats: ['image/webp', 'image/avif'],
    deviceSizes: [640, 750, 828, 1080, 1200, 1920, 2048, 3840],
    imageSizes: [16, 32, 48, 64, 96, 128, 256, 384],
    cacheImagesInDev: false,
  },
  compress: true,
  poweredByHeader: false,
  generateEtags: false,
  httpAgentOptions: {
    keepAlive: true,
  },
  async headers() {
    return [
      {
        source: '/api/(.*)',
        headers: [
          {
            key: 'Cache-Control',
            value: 'no-store, max-age=0',
          },
        ],
      },
      {
        source: '/_next/static/(.*)',
        headers: [
          {
            key: 'Cache-Control',
            value: 'public, max-age=31536000, immutable',
          },
        ],
      },
      {
        source: '/(.*\\.(js|css|xml|json|jpg|jpeg|png|gif|webp|svg|ico))',
        headers: [
          {
            key: 'Cache-Control',
            value: 'public, max-age=31536000, immutable',
          },
        ],
      },
    ];
  },
};

export default nextConfig;
```

#### **Web Vitalsä¼˜åŒ–**
```typescript
// src/lib/analytics.ts
export class PerformanceAnalytics {
  private static instance: PerformanceAnalytics;
  private metrics: {
    lcp?: number;
    fid?: number;
    cls?: number;
    fcp?: number;
    ttfb?: number;
  };

  constructor() {
    this.metrics = {};
    this.initializeMonitoring();
  }

  static getInstance(): PerformanceAnalytics {
    if (!PerformanceAnalytics.instance) {
      PerformanceAnalytics.instance = new PerformanceAnalytics();
    }
    return PerformanceAnalytics.instance;
  }

  private initializeMonitoring(): void {
    // ç›‘å¬ LCP
    if ('PerformanceObserver' in window) {
      new PerformanceObserver((entryList) => {
        const entries = entryList.getEntries();
        const lcpEntry = entries[entries.length - 1];
        this.metrics.lcp = lcpEntry.startTime;
        this.sendToAnalytics('LCP', lcpEntry.startTime);
      }).observe({ entryTypes: ['largest-contentful-paint'] });
    }

    // ç›‘å¬ FID
    new PerformanceObserver((entryList) => {
      const entries = entryList.getEntries();
      const fidEntry = entries[0];
      this.metrics.fid = fidEntry.processingStart - fidEntry.startTime;
      this.sendToAnalytics('FID', this.metrics.fid);
    }).observe({ entryTypes: ['first-input'] });

    // ç›‘å¬ CLS
    new PerformanceObserver((entryList) => {
      let clsValue = 0;
      entryList.getEntries().forEach((entry) => {
        if (!entry.hadRecentInput) {
          clsValue += entry.sourceRect.width * entry.sourceRect.height;
        }
      });
      this.metrics.cls = clsValue;
      this.sendToAnalytics('CLS', clsValue);
    }).observe({ entryTypes: ['layout-shift'] });
  }

  private sendToAnalytics(name: string, value: number): void {
    // å‘é€åˆ°åˆ†ææœåŠ¡
    if (process.env.NODE_ENV === 'production') {
      fetch('/api/analytics/performance', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          name,
          value,
          timestamp: Date.now(),
          url: window.location.href,
        }),
      }).catch(console.error);
    }
  }

  // è·å–æ€§èƒ½è¯„åˆ†
  getPerformanceScore(): number {
    const weights = {
      LCP: 0.25,
      FID: 0.25,
      CLS: 0.25,
      FCP: 0.15,
      TTFB: 0.10
    };

    const scores = {
      LCP: this.calculateLCPScore(),
      FID: this.calculateFIDScore(),
      CLS: this.calculateCLSScore(),
      FCP: this.calculateFCPScore(),
      TTFB: this.calculateTTFBScore()
    };

    const weightedScore = Object.entries(weights).reduce((total, [key, weight]) => {
      const score = scores[key as keyof typeof scores] || 0;
      return total + (score * weight);
    }, 0);

    return Math.round(weightedScore * 100) / 100;
  }

  private calculateLCPScore(): number {
    const lcp = this.metrics.lcp || 0;
    if (lcp < 2500) return 1;
    if (lcp < 4000) return 0.5;
    return 0;
  }

  private calculateFIDScore(): number {
    const fid = this.metrics.fid || 0;
    if (fid < 100) return 1;
    if (fid < 300) return 0.5;
    return 0;
  }

  private calculateCLSScore(): number {
    const cls = this.metrics.cls || 0;
    if (cls < 0.1) return 1;
    if (cls < 0.25) return 0.5;
    return 0;
  }

  private calculateFCPScore(): number {
    return 1; // ç®€åŒ–å®ç°
  }

  private calculateTTFBScore(): number {
    return 1; // ç®€åŒ–å®ç°
  }
}

// åœ¨é¡µé¢ä¸­ä½¿ç”¨
const analytics = PerformanceAnalytics.getInstance();
export default analytics;
```


---

## ğŸ¨ è®¾è®¡ç³»ç»Ÿå’Œç»„ä»¶åº“

### 10.1 è®¾è®¡ç³»ç»Ÿæ¶æ„

```typescript
// frontend/src/design-system/index.ts
export interface DesignSystem {
  // è‰²å½©ç³»ç»Ÿ
  colors: {
    primary: {
      50: string;
      100: string;
      500: string;
      600: string;
      700: string;
      900: string;
    };
    secondary: {
      500: string;
      600: string;
    };
    success: string;
    warning: string;
    error: string;
    text: {
      primary: string;
      secondary: string;
      disabled: string;
    };
    background: {
      primary: string;
      secondary: string;
      card: string;
    };
  };

  // é—´è·ç³»ç»Ÿ
  spacing: {
    xs: '0.25rem';  // 4px
    sm: '0.5rem';   // 8px
    md: '1rem';     // 16px
    lg: '1.5rem';   // 24px
    xl: '2rem';     // 32px
    '2xl': '3rem';  // 48px
  };

  // å­—ä½“ç³»ç»Ÿ
  typography: {
    fontFamily: {
      sans: ['Inter', 'system-ui', 'sans-serif'];
      mono: ['JetBrains Mono', 'Consolas', 'monospace'];
    };
    fontSize: {
      xs: '0.875rem';   // 14px
      sm: '1rem';      // 16px
      base: '1.125rem'; // 18px
      lg: '1.25rem';   // 20px
      xl: '1.5rem';    // 24px
      '2xl': '2rem';   // 32px
    };
    fontWeight: {
      normal: 400;
      medium: 500;
      semibold: 600;
      bold: 700;
    };
    lineHeight: {
      tight: 1.25;
      normal: 1.5;
      relaxed: 1.75;
    };
  };

  // åœ†è§’ç³»ç»Ÿ
  borderRadius: {
    sm: '0.25rem';  // 4px
    md: '0.375rem'; // 6px
    lg: '0.5rem';   // 8px
    full: '9999px';
  };

  // é˜´å½±ç³»ç»Ÿ
  shadows: {
    sm: '0 1px 2px 0 rgba(0, 0, 0, 0.05)';
    md: '0 4px 6px -1px rgba(0, 0, 0, 0.1)';
    lg: '0 10px 15px -3px rgba(0, 0, 0, 0.1)';
    xl: '0 20px 25px -5px rgba(0, 0, 0, 0.1)';
    card: '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)';
  };

  // åŠ¨ç”»ç³»ç»Ÿ
  animation: {
    duration: {
      fast: 150;
      normal: 300;
      slow: 500;
    };
    easing: {
      linear: 'linear';
      ease: 'ease';
      easeIn: 'ease-in';
      easeOut: 'ease-out';
      easeInOut: 'ease-in-out';
    };
  };
}
```

### 10.2 ä¸»é¢˜é…ç½®

```typescript
// frontend/src/design-system/theme.ts
import { DesignSystem } from './index';

// ä¸»ä¸»é¢˜
export const lightTheme: DesignSystem = {
  colors: {
    primary: {
      50: '#eff6ff',
      100: '#dbeafe',
      500: '#3b82f6',
      600: '#2563eb',
      700: '#1d4ed8',
      900: '#1e3a8a',
    },
    secondary: {
      500: '#6366f1',
      600: '#5b21b6',
    },
    success: '#10b981',
    warning: '#f59e0b',
    error: '#ef4444',
    text: {
      primary: '#111827',
      secondary: '#6b7280',
      disabled: '#9ca3af',
    },
    background: {
      primary: '#ffffff',
      secondary: '#f9fafb',
      card: '#ffffff',
    },
  },
  spacing: {
    xs: '0.25rem',
    sm: '0.5rem',
    md: '1rem',
    lg: '1.5rem',
    xl: '2rem',
    '2xl': '3rem',
  },
  typography: {
    fontFamily: {
      sans: ['Inter', 'system-ui', 'sans-serif'],
      mono: ['JetBrains Mono', 'Consolas', 'monospace'],
    },
    fontSize: {
      xs: '0.875rem',
      sm: '1rem',
      base: '1.125rem',
      lg: '1.25rem',
      xl: '1.5rem',
      '2xl': '2rem',
    },
    fontWeight: {
      normal: 400,
      medium: 500,
      semibold: 600,
      bold: 700,
    },
    lineHeight: {
      tight: 1.25,
      normal: 1.5,
      relaxed: 1.75,
    },
  },
  borderRadius: {
    sm: '0.25rem',
    md: '0.375rem',
    lg: '0.5rem',
    full: '9999px',
  },
  shadows: {
    sm: '0 1px 2px 0 rgba(0, 0, 0, 0.05)',
    md: '0 4px 6px -1px rgba(0, 0, 0, 0.1)',
    lg: '0 10px 15px -3px rgba(0, 0, 0, 0.1)',
    xl: '0 20px 25px -5px rgba(0, 0, 0, 0.1)',
    card: '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)',
  },
  animation: {
    duration: {
      fast: 150,
      normal: 300,
      slow: 500,
    },
    easing: {
      linear: 'linear',
      ease: 'ease',
      easeIn: 'ease-in',
      easeOut: 'ease-out',
      easeInOut: 'ease-in-out',
    },
  },
};

// æš—é»‘ä¸»é¢˜
export const darkTheme: DesignSystem = {
  ...lightTheme,
  colors: {
    ...lightTheme.colors,
    primary: {
      50: '#1e293b',
      100: '#334155',
      500: '#60a5fa',
      600: '#3b82f6',
      700: '#2563eb',
      900: '#1e40af',
    },
    text: {
      primary: '#f1f5f9',
      secondary: '#cbd5e1',
      disabled: '#94a3b8',
    },
    background: {
      primary: '#0f172a',
      secondary: '#1e293b',
      card: '#1e293b',
    },
  },
};
```

### 10.3 åŸºç¡€ç»„ä»¶åº“

#### Button ç»„ä»¶

```typescript
// frontend/src/components/ui/button.tsx
import React from 'react';
import { cn } from '@/lib/utils';

export interface ButtonProps extends React.ButtonHTMLAttributes<HTMLButtonElement> {
  variant?: 'default' | 'secondary' | 'ghost' | 'outline' | 'destructive';
  size?: 'sm' | 'md' | 'lg' | 'icon';
  loading?: boolean;
  leftIcon?: React.ReactNode;
  rightIcon?: React.ReactNode;
}

const Button = React.forwardRef<HTMLButtonElement, ButtonProps>(({
  className,
  variant = 'default',
  size = 'md',
  loading = false,
  leftIcon,
  rightIcon,
  children,
  disabled,
  ...props
}, ref) => {
  const isDisabled = disabled || loading;

  return (
    <button
      className={cn(
        // åŸºç¡€æ ·å¼
        'inline-flex items-center justify-center gap-2 rounded-md font-medium transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed',

        // å˜ä½“æ ·å¼
        {
          'default': 'bg-primary-600 text-white hover:bg-primary-700 focus:ring-primary-500',
          'secondary': 'bg-secondary-500 text-white hover:bg-secondary-600 focus:ring-secondary-500',
          'ghost': 'text-primary-600 hover:bg-primary-50 hover:text-primary-700 focus:ring-primary-500',
          'outline': 'border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 focus:ring-gray-500',
          'destructive': 'bg-red-600 text-white hover:bg-red-700 focus:ring-red-500',
        }[variant],

        // å°ºå¯¸æ ·å¼
        {
          'sm': 'h-9 px-3 text-xs',
          'md': 'h-10 px-4 text-sm',
          'lg': 'h-12 px-6 text-base',
          'icon': 'h-10 w-10 p-0',
        }[size],

        className
      )}
      ref={ref}
      disabled={isDisabled}
      {...props}
    >
      {loading && (
        <svg className="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
          <path className="opacity-75" fill="currentColor" d="m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
      )}
      {!loading && leftIcon && <span className="button-left-icon">{leftIcon}</span>}
      {children}
      {!loading && rightIcon && <span className="button-right-icon">{rightIcon}</span>}
    </button>
  );
});

Button.displayName = 'Button';
export { Button };
```

#### Input ç»„ä»¶

```typescript
// frontend/src/components/ui/input.tsx
import React from 'react';
import { cn } from '@/lib/utils';

export interface InputProps extends React.InputHTMLAttributes<HTMLInputElement> {
  label?: string;
  error?: string;
  helperText?: string;
  leftIcon?: React.ReactNode;
  rightIcon?: React.ReactNode;
}

const Input = React.forwardRef<HTMLInputElement, InputProps>(({
  className,
  type,
  label,
  error,
  helperText,
  leftIcon,
  rightIcon,
  id,
  ...props
}, ref) => {
  const inputId = id || `input-${Math.random().toString(36).substr(2, 9)}`;

  return (
    <div className="space-y-2">
      {label && (
        <label
          htmlFor={inputId}
          className={cn(
            'block text-sm font-medium transition-colors',
            error ? 'text-red-600' : 'text-gray-700'
          )}
        >
          {label}
        </label>
      )}

      <div className="relative">
        {leftIcon && (
          <div className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400">
            {leftIcon}
          </div>
        )}

        <input
          type={type}
          id={inputId}
          className={cn(
            'flex w-full rounded-md border transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium',
            'placeholder:text-gray-400 focus:outline-none focus:ring-2 focus:ring-offset-0',
            error
              ? 'border-red-300 focus:border-red-500 focus:ring-red-500'
              : 'border-gray-300 focus:border-primary-500 focus:ring-primary-500',
            leftIcon && 'pl-10',
            rightIcon && 'pr-10',
            className
          )}
          ref={ref}
          {...props}
        />

        {rightIcon && (
          <div className="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400">
            {rightIcon}
          </div>
        )}
      </div>

      {error && (
        <p className="text-sm text-red-600">{error}</p>
      )}
      {helperText && !error && (
        <p className="text-sm text-gray-500">{helperText}</p>
      )}
    </div>
  );
});

Input.displayName = 'Input';
export { Input };
```

#### Card ç»„ä»¶

```typescript
// frontend/src/components/ui/card.tsx
import React from 'react';
import { cn } from '@/lib/utils';

export interface CardProps extends React.HTMLAttributes<HTMLDivElement> {
  variant?: 'default' | 'outlined' | 'elevated';
  padding?: 'none' | 'sm' | 'md' | 'lg';
}

const Card = React.forwardRef<HTMLDivElement, CardProps>(({
  className,
  variant = 'default',
  padding = 'md',
  children,
  ...props
}, ref) => {
  return (
    <div
      ref={ref}
      className={cn(
        'bg-white transition-all duration-200',
        {
          'default': '',
          'outlined': 'border border-gray-200',
          'elevated': 'shadow-lg',
        }[variant],
        {
          'none': '',
          'sm': 'p-3',
          'md': 'p-6',
          'lg': 'p-8',
        }[padding],
        className
      )}
      {...props}
    >
      {children}
    </div>
  );
});

Card.displayName = 'Card';

const CardHeader = ({ className, ...props }: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn('flex flex-col space-y-1.5 p-6 pb-0', className)}
    {...props}
  />
);

const CardTitle = ({ className, ...props }: React.HTMLAttributes<HTMLHeadingElement>) => (
  <h3
    className={cn('text-lg font-semibold leading-none tracking-tight', className)}
    {...props}
  />
);

const CardDescription = ({ className, ...props }: React.HTMLAttributes<HTMLParagraphElement>) => (
  <p
    className={cn('text-sm text-gray-500', className)}
    {...props}
  />
);

const CardContent = ({ className, ...props }: React.HTMLAttributes<HTMLDivElement>) => (
  <div className={cn('p-6 pt-0', className)} {...props} />
);

const CardFooter = ({ className, ...props }: React.HTMLAttributes<HTMLDivElement>) => (
  <div
    className={cn('flex items-center p-6 pt-0', className)}
    {...props}
  />
);

export { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent };
```

### 10.4 ä¸šåŠ¡ç»„ä»¶

#### ProgressRing ç»„ä»¶ï¼ˆå­¦ä¹ è¿›åº¦ï¼‰

```typescript
// frontend/src/components/learning/progress-ring.tsx
import React from 'react';
import { cn } from '@/lib/utils';

export interface ProgressRingProps {
  progress: number; // 0-100
  size?: number;
  strokeWidth?: number;
  color?: string;
  backgroundColor?: string;
  showPercentage?: boolean;
  className?: string;
}

const ProgressRing: React.FC<ProgressRingProps> = ({
  progress,
  size = 120,
  strokeWidth = 8,
  color = '#3b82f6',
  backgroundColor = '#e5e7eb',
  showPercentage = true,
  className
}) => {
  const normalizedRadius = (size - strokeWidth) / 2;
  const circumference = normalizedRadius * 2 * Math.PI;
  const strokeDasharray = `${circumference} ${circumference}`;
  const strokeDashoffset = circumference - (Math.min(Math.max(progress, 0), 100) / 100) * circumference;

  return (
    <div className={cn('relative inline-flex items-center justify-center', className)}>
      <svg
        height={size}
        width={size}
        className={cn('transform -rotate-90', showPercentage && 'scale-90')}
      >
        {/* èƒŒæ™¯åœ†ç¯ */}
        <circle
          stroke={backgroundColor}
          fill="transparent"
          strokeWidth={strokeWidth}
          r={normalizedRadius}
          cx={size / 2}
          cy={size / 2}
        />

        {/* è¿›åº¦åœ†ç¯ */}
        <circle
          stroke={color}
          fill="transparent"
          strokeWidth={strokeWidth}
          strokeDasharray={strokeDasharray}
          strokeDashoffset={strokeDashoffset}
          strokeLinecap="round"
          r={normalizedRadius}
          cx={size / 2}
          cy={size / 2}
          className="transition-all duration-500 ease-in-out"
        />
      </svg>

      {showPercentage && (
        <div className="absolute inset-0 flex items-center justify-center">
          <span className="text-lg font-semibold text-gray-700">
            {Math.round(progress)}%
          </span>
        </div>
      )}
    </div>
  );
};

export default ProgressRing;
```

#### SkillBadge ç»„ä»¶ï¼ˆæŠ€èƒ½æ ‡ç­¾ï¼‰

```typescript
// frontend/src/components/learning/skill-badge.tsx
import React from 'react';
import { cn } from '@/lib/utils';

export interface SkillBadgeProps {
  skill: 'listening' | 'speaking' | 'reading' | 'writing';
  level?: number; // 1-9
  size?: 'sm' | 'md' | 'lg';
  showLevel?: boolean;
  className?: string;
}

const SkillBadge: React.FC<SkillBadgeProps> = ({
  skill,
  level = 0,
  size = 'md',
  showLevel = true,
  className
}) => {
  const getSkillInfo = () => {
    switch (skill) {
      case 'listening':
        return { color: 'bg-blue-100 text-blue-800', label: 'å¬åŠ›' };
      case 'speaking':
        return { color: 'bg-green-100 text-green-800', label: 'å£è¯­' };
      case 'reading':
        return { color: 'bg-purple-100 text-purple-800', label: 'é˜…è¯»' };
      case 'writing':
        return { color: 'bg-orange-100 text-orange-800', label: 'å†™ä½œ' };
      default:
        return { color: 'bg-gray-100 text-gray-800', label: 'æœªçŸ¥' };
    }
  };

  const skillInfo = getSkillInfo();

  const sizeClasses = {
    sm: 'text-xs px-2 py-1',
    md: 'text-sm px-3 py-1.5',
    lg: 'text-base px-4 py-2'
  };

  return (
    <div className={cn('inline-flex items-center gap-1', className)}>
      <span
        className={cn(
          'inline-flex items-center rounded-full font-medium',
          skillInfo.color,
          sizeClasses[size]
        )}
      >
        {skillInfo.label}
      </span>
      {showLevel && level > 0 && (
        <span
          className={cn(
            'inline-flex items-center rounded-full font-bold',
            level >= 8 ? 'bg-red-100 text-red-800' :
            level >= 6 ? 'bg-yellow-100 text-yellow-800' :
            'bg-gray-100 text-gray-800',
            sizeClasses[size]
          )}
        >
          CLB {level}
        </span>
      )}
    </div>
  );
};

export default SkillBadge;
```

#### ResourceCard ç»„ä»¶ï¼ˆå­¦ä¹ èµ„æºå¡ç‰‡ï¼‰

```typescript
// frontend/src/components/resources/resource-card.tsx
import React from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import SkillBadge from '@/components/learning/skill-badge';
import { Clock, Users, Star } from 'lucide-react';

export interface Resource {
  id: string;
  title: string;
  description: string;
  type: 'video' | 'article' | 'practice' | 'template';
  skill: 'listening' | 'speaking' | 'reading' | 'writing';
  difficulty: 7 | 8 | 9;
  duration?: number; // åˆ†é’Ÿ
  rating?: number;
  viewCount?: number;
  thumbnail?: string;
  author: string;
  tags: string[];
}

interface ResourceCardProps {
  resource: Resource;
  onClick?: () => void;
  className?: string;
}

const ResourceCard: React.FC<ResourceCardProps> = ({
  resource,
  onClick,
  className
}) => {
  const getTypeIcon = (type: string) => {
    switch (type) {
      case 'video': return 'ğŸ“¹';
      case 'article': return 'ğŸ“–';
      case 'practice': return 'âœï¸';
      case 'template': return 'ğŸ“‹';
      default: return 'ğŸ“„';
    }
  };

  const getDifficultyColor = (difficulty: number) => {
    switch (difficulty) {
      case 7: return 'text-yellow-600';
      case 8: return 'text-orange-600';
      case 9: return 'text-red-600';
      default: return 'text-gray-600';
    }
  };

  return (
    <Card
      className={cn(
        'hover:shadow-lg transition-all duration-200 cursor-pointer group',
        className
      )}
      onClick={onClick}
    >
      <CardHeader className="pb-3">
        <div className="flex items-start justify-between">
          <div className="flex-1">
            <CardTitle className="text-lg mb-2 group-hover:text-primary-600 transition-colors">
              {resource.title}
            </CardTitle>
            <div className="flex items-center gap-3 text-sm text-gray-500">
              <span className="flex items-center gap-1">
                {getTypeIcon(resource.type)} {resource.type}
              </span>
              <SkillBadge
                skill={resource.skill}
                size="sm"
                showLevel={false}
              />
              <span className={getDifficultyColor(resource.difficulty)}>
                éš¾åº¦ CLB {resource.difficulty}
              </span>
            </div>
          </div>
          {resource.thumbnail && (
            <img
              src={resource.thumbnail}
              alt={resource.title}
              className="w-20 h-12 object-cover rounded ml-4 flex-shrink-0"
            />
          )}
        </div>
      </CardHeader>

      <CardContent className="pt-0">
        <p className="text-sm text-gray-600 mb-4 line-clamp-2">
          {resource.description}
        </p>

        <div className="flex items-center justify-between text-xs text-gray-500 mb-4">
          <span className="flex items-center gap-1">
            <Clock className="w-3 h-3" /> {resource.duration || 0}åˆ†é’Ÿ
          </span>
          {resource.rating && (
            <span className="flex items-center gap-1">
              <Star className="w-3 h-3 fill-current text-yellow-400" />
              {resource.rating}
            </span>
          )}
          <span className="flex items-center gap-1">
            <Users className="w-3 h-3" /> {resource.viewCount || 0}
          </span>
        </div>

        <div className="flex flex-wrap gap-1 mb-4">
          {resource.tags.map((tag, index) => (
            <span
              key={index}
              className="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded"
            >
              {tag}
            </span>
          ))}
        </div>

        <Button
          variant="outline"
          size="sm"
          className="w-full"
          onClick={(e) => {
            e.stopPropagation();
            onClick?.();
          }}
        >
          å¼€å§‹å­¦ä¹ 
        </Button>
      </CardContent>
    </Card>
  );
};

export default ResourceCard;
```

### 10.5 å“åº”å¼å·¥å…·ç±»

```typescript
// frontend/src/lib/responsive.ts
import { useState, useEffect } from 'react';

type Breakpoint = 'xs' | 'sm' | 'md' | 'lg' | 'xl';

const breakpoints: Record<Breakpoint, number> = {
  xs: 0,
  sm: 480,
  md: 769,
  lg: 1025,
  xl: 1441,
};

export const useMediaQuery = (query: string): boolean => {
  const [matches, setMatches] = useState(false);

  useEffect(() => {
    const media = window.matchMedia(query);
    setMatches(media.matches);

    const listener = () => setMatches(media.matches);
    media.addListener(listener);
    return () => media.removeListener(listener);
  }, [query]);

  return matches;
};

export const useBreakpoint = (): {
  breakpoint: Breakpoint;
  isXs: boolean;
  isSm: boolean;
  isMd: boolean;
  isLg: boolean;
  isXl: boolean;
  isMobile: boolean;
  isTablet: boolean;
  isDesktop: boolean;
} => {
  const [breakpoint, setBreakpoint] = useState<Breakpoint>('xs');
  const [windowSize, setWindowSize] = useState({
    width: typeof window !== 'undefined' ? window.innerWidth : 0,
    height: typeof window !== 'undefined' ? window.innerHeight : 0,
  });

  useEffect(() => {
    const handleResize = () => {
      const width = window.innerWidth;
      setWindowSize({ width, height: window.innerHeight });

      if (width >= breakpoints.xl) setBreakpoint('xl');
      else if (width >= breakpoints.lg) setBreakpoint('lg');
      else if (width >= breakpoints.md) setBreakpoint('md');
      else if (width >= breakpoints.sm) setBreakpoint('sm');
      else setBreakpoint('xs');
    };

    window.addEventListener('resize', handleResize);
    handleResize();

    return () => window.removeEventListener('resize', handleResize);
  }, []);

  return {
    breakpoint,
    isXs: breakpoint === 'xs',
    isSm: breakpoint === 'sm',
    isMd: breakpoint === 'md',
    isLg: breakpoint === 'lg',
    isXl: breakpoint === 'xl',
    isMobile: ['xs', 'sm'].includes(breakpoint),
    isTablet: breakpoint === 'md',
    isDesktop: ['lg', 'xl'].includes(breakpoint),
  };
};

// å“åº”å€¼å·¥å…·
export const getResponsiveValue = <T>(
  values: Partial<Record<Breakpoint, T>>,
  currentBreakpoint: Breakpoint,
  defaultValue: T
): T => {
  const breakpointOrder: Breakpoint[] = ['xl', 'lg', 'md', 'sm', 'xs'];
  const currentIndex = breakpointOrder.indexOf(currentBreakpoint);

  for (let i = currentIndex; i < breakpointOrder.length; i++) {
    const bp = breakpointOrder[i];
    if (values[bp] !== undefined) {
      return values[bp]!;
    }
  }

  return defaultValue;
};
```

### 10.6 å¯è®¿é—®æ€§ç»„ä»¶

```typescript
// frontend/src/components/accessible/accessible-icon.tsx
import React from 'react';
import { cn } from '@/lib/utils';

interface AccessibleIconProps {
  icon: React.ReactNode;
  label: string;
  className?: string;
}

const AccessibleIcon: React.FC<AccessibleIconProps> = ({
  icon,
  label,
  className
}) => {
  return (
    <span className={cn('relative inline-block', className)} role="img" aria-label={label}>
      {icon}
      <span className="sr-only">{label}</span>
    </span>
  );
};

export default AccessibleIcon;

// é”®ç›˜å¯¼èˆªå¢å¼º Hook
export const useKeyboardNavigation = (
  items: any[],
  options: {
    loop?: boolean;
    orientation?: 'horizontal' | 'vertical';
  } = {}
) => {
  const { loop = true, orientation = 'vertical' } = options;
  const [focusedIndex, setFocusedIndex] = useState(0);

  const handleKeyDown = (event: React.KeyboardEvent) => {
    const isVertical = orientation === 'vertical';
    const nextKey = isVertical ? 'ArrowDown' : 'ArrowRight';
    const prevKey = isVertical ? 'ArrowUp' : 'ArrowLeft';
    const homeKey = 'Home';
    const endKey = 'End';

    switch (event.key) {
      case nextKey:
        event.preventDefault();
        setFocusedIndex(prev =>
          loop ? (prev + 1) % items.length : Math.min(prev + 1, items.length - 1)
        );
        break;
      case prevKey:
        event.preventDefault();
        setFocusedIndex(prev =>
          loop ? (prev - 1 + items.length) % items.length : Math.max(prev - 1, 0)
        );
        break;
      case homeKey:
        event.preventDefault();
        setFocusedIndex(0);
        break;
      case endKey:
        event.preventDefault();
        setFocusedIndex(items.length - 1);
        break;
      case 'Enter':
      case ' ':
        event.preventDefault();
        // è§¦å‘å½“å‰é¡¹çš„ç‚¹å‡»äº‹ä»¶
        items[focusedIndex]?.onClick?.();
        break;
    }
  };

  return {
    focusedIndex,
    setFocusedIndex,
    handleKeyDown,
    focusedItem: items[focusedIndex],
  };
};
```

### 10.7 ç»„ä»¶æµ‹è¯•ç¤ºä¾‹

```typescript
// frontend/src/components/__tests__/button.test.tsx
import { render, screen, fireEvent } from '@testing-library/react';
import { Button } from '../ui/button';

describe('Button Component', () => {
  test('renders with default props', () => {
    render(<Button>Click me</Button>);
    expect(screen.getByRole('button', { name: /click me/i })).toBeInTheDocument();
  });

  test('handles click events', () => {
    const handleClick = jest.fn();
    render(<Button onClick={handleClick}>Click me</Button>);
    fireEvent.click(screen.getByRole('button'));
    expect(handleClick).toHaveBeenCalledTimes(1);
  });

  test('shows loading state', () => {
    render(<Button loading>Click me</Button>);
    expect(screen.getByRole('button')).toBeDisabled();
    expect(screen.getByTestId('spinner')).toBeInTheDocument();
  });

  test('applies variant classes correctly', () => {
    render(<Button variant="destructive">Delete</Button>);
    expect(screen.getByRole('button')).toHaveClass('bg-red-600');
  });
});

// frontend/src/components/__tests__/resource-card.test.tsx
import { render, screen } from '@testing-library/react';
import ResourceCard from '../resources/resource-card';
import { Resource } from '../resources/resource-card';

const mockResource: Resource = {
  id: '1',
  title: 'CELPIP Listening Practice',
  description: 'Practice test for listening comprehension',
  type: 'video',
  skill: 'listening',
  difficulty: 8,
  duration: 30,
  rating: 4.5,
  viewCount: 1000,
  author: 'HZad Education',
  tags: ['practice', 'listening'],
};

describe('ResourceCard Component', () => {
  test('renders resource information', () => {
    render(<ResourceCard resource={mockResource} />);
    expect(screen.getByText('CELPIP Listening Practice')).toBeInTheDocument();
    expect(screen.getByText('Practice test for listening comprehension')).toBeInTheDocument();
    expect(screen.getByText('å¬åŠ›')).toBeInTheDocument();
  });

  test('displays difficulty level', () => {
    render(<ResourceCard resource={mockResource} />);
    expect(screen.getByText('éš¾åº¦ CLB 8')).toBeInTheDocument();
  });

  test('calls click handler when clicked', () => {
    const handleClick = jest.fn();
    render(<ResourceCard resource={mockResource} onClick={handleClick} />);
    fireEvent.click(screen.getByRole('button'));
    expect(handleClick).toHaveBeenCalledTimes(1);
  });
});
```

---

## ğŸ“Š éƒ¨ç½²æ£€æŸ¥æ¸…å•

### ä¸Šçº¿å‰æ£€æŸ¥

- [ ] **æ€§èƒ½**
  - [ ] LCP < 2.5s
  - [ ] FID < 100ms
  - [ ] é¦–å± < 2s

- [ ] **å“åº”å¼**
  - [ ] æµ‹è¯•æ‰€æœ‰è®¾å¤‡ (iPhone SE / 8 / 12 / iPad / Desktop)
  - [ ] æµ‹è¯•æ‰€æœ‰æµè§ˆå™¨ (Chrome / Safari / Firefox)
  - [ ] éªŒè¯è§¦æ§æ“ä½œ

- [ ] **å®‰å…¨**
  - [ ] å¯ç”¨ HTTPS
  - [ ] è®¾ç½® CSP headers
  - [ ] ç§»é™¤æ•æ„Ÿä¿¡æ¯
  - [ ] è¿è¡Œå®‰å…¨æ‰«æ

- [ ] **å¯è®¿é—®æ€§**
  - [ ] é¢œè‰²å¯¹æ¯”åº¦ â‰¥ 4.5:1
  - [ ] é”®ç›˜å¯¼èˆªå®Œæ•´
  - [ ] å±å¹•é˜…è¯»å™¨æµ‹è¯•
  - [ ] WCAG 2.1 AA æ ‡å‡†

- [ ] **SEO**
  - [ ] Metaæ ‡ç­¾å®Œæ•´
  - [ ] Sitemap.xml
  - [ ] robots.txt
  - [ ] Open Graph tags

---

**CELPIP Compass Detailed Technical Document**  
**ç‰ˆæœ¬ 1.0 | 2025å¹´12æœˆ29æ—¥**  
**Ready for Implementation**

